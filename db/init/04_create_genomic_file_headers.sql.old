-- Create genomic_file_headers table in public schema
-- This ensures the table exists immediately after database initialization
-- and prevents race conditions with Alembic migrations

-- Ensure uuid extension exists for uuid_generate_v4()
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create table in public schema for simplicity and broad accessibility
CREATE TABLE IF NOT EXISTS genomic_file_headers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    file_path TEXT NOT NULL,
    file_format VARCHAR(10) NOT NULL CHECK (file_format IN ('BAM','SAM','CRAM','VCF','BCF','FASTA','FASTQ')),
    header_info JSONB NOT NULL,
    extracted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_gfh_file_format ON genomic_file_headers(file_format);
CREATE INDEX IF NOT EXISTS idx_gfh_header_info_gin ON genomic_file_headers USING GIN (header_info);

-- Grant permissions to the database user
GRANT ALL PRIVILEGES ON TABLE genomic_file_headers TO cpic_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO cpic_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO cpic_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO cpic_user;

-- Comment to document the table's purpose
COMMENT ON TABLE genomic_file_headers IS 'Stores parsed header information from genomic files (BAM, VCF, etc.)';
COMMENT ON COLUMN genomic_file_headers.header_info IS 'Normalized JSON structure containing file format-specific header metadata';
