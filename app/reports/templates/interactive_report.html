<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Pharmacogenomic Report - {{ report_id }}</title>
    <!-- Include Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include D3.js for advanced visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e67e22;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            background-color: var(--primary-color);
            color: white;
        }
        
        .logo {
            max-width: 150px;
            margin-bottom: 10px;
        }
        
        h1, h2, h3, h4 {
            color: var(--primary-color);
        }
        
        .report-info {
            display: flex;
            justify-content: space-between;
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        
        .report-info-item {
            flex: 1;
            padding: 0 10px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light-color);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            background-color: var(--light-color);
        }
        
        .tab.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .gene-phenotype {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .normal-metabolizer {
            background-color: var(--success-color);
        }
        
        .poor-metabolizer {
            background-color: var(--danger-color);
        }
        
        .intermediate-metabolizer {
            background-color: var(--warning-color);
            color: #333;
        }
        
        .rapid-metabolizer, .ultrarapid-metabolizer {
            background-color: var(--info-color);
        }
        
        /* Possibly Wild Type: transparent background with black border (VCF only) */
        .possibly-wild-type {
            background-color: transparent;
            color: #000;
            border: 2px solid #000;
        }
        
        /* Likely Wild Type: transparent background with light green border (BAM/FASTQ/CRAM) */
        .likely-wild-type {
            background-color: transparent;
            color: #000;
            border: 2px solid #90EE90;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light-color);
            font-weight: bold;
        }
        
        tr:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
        .narrow-col {
            width: 1.2em;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .narrow-col th {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            height: 3em;
            vertical-align: bottom;
            padding: 0.5em 0.2em;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Enhanced workflow diagram styling to prevent overlaps and clashes */
        .workflow-section {
            margin-top: 40px;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }
        
        .workflow-figure {
            margin: 20px 0;
            padding: 20px;
            background: #ffffff;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .workflow-figure svg {
            display: block;
            max-width: 100%;
            height: auto;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        
        .workflow-figure img {
            display: block;
            max-width: 100%;
            height: auto;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        
        .workflow-figure > * {
            margin: 0;
            padding: 0;
        }
        
        .workflow-figure + * {
            margin-top: 20px;
        }
        
        .workflow-section + .section {
            margin-top: 30px;
        }
        
        /* Ensure proper spacing around workflow section */
        .card:has(h4:contains("Workflow")) {
            margin-bottom: 40px;
        }
        
        /* Chart container enhancements */
        .chart-container {
            max-width: 100%;
            padding: 20px;
            border: 2px solid #e1e8ed;
            background: #ffffff;
            margin: 20px 0 30px 0;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
            overflow: hidden;
        }
        
        /* Ensure SVG text is visible */
        .chart-container svg text,
        .chart-container svg tspan {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            font-size: 12px !important;
            fill: #2c3e50 !important;
        }
        
        /* Workflow text fallback styling */
        .workflow-text {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        /* Print media queries for PDF generation */
        @media print {
            .workflow-figure,
            .chart-container {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin: 20px 0 !important;
                padding: 15px !important;
                border: 2px solid #000 !important;
                background: #ffffff !important;
                position: relative !important;
                z-index: 1 !important;
            }
            
            .workflow-figure svg,
            .workflow-figure img,
            .chart-container svg,
            .chart-container img {
                max-width: 100% !important;
                height: auto !important;
                display: block !important;
                margin: 0 auto !important;
                background: #ffffff !important;
                position: relative !important;
                z-index: 1 !important;
            }
            
            .workflow-figure text,
            .workflow-figure tspan,
            .chart-container text,
            .chart-container tspan {
                font-family: 'Arial', sans-serif !important;
                font-size: 12px !important;
                fill: #000000 !important;
                color: #000000 !important;
            }
            
            .workflow-figure div,
            .chart-container div {
                position: relative !important;
                z-index: 1 !important;
            }
            
            .workflow-figure *,
            .chart-container * {
                position: relative !important;
                z-index: 1 !important;
            }
        }
        
        .drug-card {
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.3s ease;
        }
        
        .drug-card:hover {
            transform: translateY(-3px);
        }
        
        /* Evidence-based border colors for drug cards */
        .drug-card.evidence-3 {
            border-left-color: var(--danger-color);
        }
        .drug-card.evidence-2 {
            border-left-color: var(--warning-color);
        }
        .drug-card.evidence-1 {
            border-left-color: var(--info-color);
        }
        .drug-card.evidence-0 {
            border-left-color: #6c757d;
        }
        
        /* Evidence-based border colors for individual recommendation cards */
        .gene-recommendation {
            border-left: 3px solid #007bff; /* Default blue */
        }
        .gene-recommendation.evidence-3 {
            border-left-color: var(--danger-color) !important;
        }
        .gene-recommendation.evidence-2 {
            border-left-color: var(--warning-color) !important;
        }
        .gene-recommendation.evidence-1 {
            border-left-color: var(--info-color) !important;
        }
        .gene-recommendation.evidence-0 {
            border-left-color: #6c757d !important;
        }
        
        .normal-card {
            border-left-color: var(--success-color);
        }
        
        .warning-card {
            border-left-color: var(--warning-color);
        }
        
        .alert-card {
            border-left-color: var(--danger-color);
        }
        
        .info-card {
            border-left-color: var(--info-color);
        }
        
        .drug-card h3 {
            margin-top: 0;
            display: flex;
            justify-content: space-between;
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        
        .disclaimer {
            margin-top: 50px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 5px;
            font-size: 0.9em;
            color: #666;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        /* Single column layout for drug recommendations */
        .recs-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .recs-list .drug-card {
            width: 100%;
            max-width: none;
        }
        
        @media (max-width: 768px) {
            .report-info {
                flex-direction: column;
            }
            
            .report-info-item {
                margin-bottom: 10px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Form styles */
        .form-control {
            display: block;
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .form-label {
            margin-bottom: 0.5rem;
            display: inline-block;
        }
        
        .form-select {
            display: block;
            width: 100%;
            padding: 0.375rem 2.25rem 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            appearance: none;
        }
        
        .btn {
            display: inline-block;
            font-weight: 400;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: 0.25rem;
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            cursor: pointer;
        }
        
        .btn-primary {
            color: #fff;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .alert {
            position: relative;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        /* Monospaced file header styling */
        .file-header {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre;
            background-color: #fdfdfd;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 4px;
            line-height: 1.35;
            tab-size: 4;
            overflow: auto;
            word-break: normal;
        }
        .header-note {
            font-size: 0.95em;
            color: #555;
            margin: 0 0 10px 0;
        }
        
        /* Drugs grid for interactive report */
        .drugs-grid-interactive {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        
        .drug-item-interactive-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        .drug-item-interactive {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            border-radius: 6px;
            background-color: #ffffff;
            border: 2px solid #e1e8ed;
            border-left: 5px solid #6c757d;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        
        .drug-item-interactive:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .drug-item-interactive .drug-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .drug-item-interactive .drug-name {
            font-weight: 600;
            font-size: 1em;
            color: var(--dark-color);
        }
        
        /* Evidence level color coding for interactive */
        .drug-item-interactive.evidence-3 {
            border-left-color: var(--danger-color);
            background-color: #fff5f5;
        }
        
        .drug-item-interactive.evidence-3 .drug-indicator {
            background-color: var(--danger-color);
        }
        
        .drug-item-interactive.evidence-2 {
            border-left-color: var(--warning-color);
            background-color: #fffbf0;
        }
        
        .drug-item-interactive.evidence-2 .drug-indicator {
            background-color: var(--warning-color);
        }
        
        .drug-item-interactive.evidence-1 {
            border-left-color: var(--info-color);
            background-color: #f0f9fb;
        }
        
        .drug-item-interactive.evidence-1 .drug-indicator {
            background-color: var(--info-color);
        }
        
        .drug-item-interactive.evidence-0 {
            border-left-color: #6c757d;
            background-color: #f8f9fa;
        }
        
        .drug-item-interactive.evidence-0 .drug-indicator {
            background-color: #6c757d;
        }
        
        .evidence-legend {
            margin-bottom: 25px;
            padding: 15px 20px;
            background-color: var(--light-color);
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .evidence-legend p {
            margin: 0 0 12px 0;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .legend-item {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background-color: white;
            border-radius: 20px;
            border: 1px solid #dee2e6;
        }
        
        .legend-item .drug-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .legend-item.evidence-3 .drug-indicator {
            background-color: var(--danger-color);
        }
        
        .legend-item.evidence-2 .drug-indicator {
            background-color: var(--warning-color);
        }
        
        .legend-item.evidence-1 .drug-indicator {
            background-color: var(--info-color);
        }
        
        .legend-item.evidence-0 .drug-indicator {
            background-color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .drugs-grid-interactive {
                grid-template-columns: 1fr;
            }
            
            .legend-items {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <!-- <img class="logo" src="logo.png" alt="ZaroPGx Logo"> -->
        <h1>Individual Pharmacogenomic Report</h1>
        <p>Powered by ZaroPGx, a Zaromics Software Tool</p>
    </header>
    
    <div class="container">
        <div class="report-info">
            <div class="report-info-item">
                <strong>Sample ID:</strong> {{ sample_identifier or patient_id }}
            </div>
            <div class="report-info-item">
                <strong>Report ID:</strong> {{ report_id }}
            </div>
            <div class="report-info-item">
                <strong>Report Date:</strong> {{ report_date }}
            </div>
        </div>
        
        <div class="section">
            <h2>Gene-Drug Interaction Dashboard</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('summary')">Summary</div>
                <div class="tab" onclick="showTab('genes')">Genes</div>
                <div class="tab" onclick="showTab('drugs')">Drugs</div>
                <div class="tab" onclick="showTab('recs')">Recs</div>
                <div class="tab" onclick="showTab('visualizations')">Visualizations</div>
                <div class="tab" onclick="showTab('method')">Method</div>
                <div class="tab" onclick="showTab('export')">Export</div>
                <div class="tab" onclick="showTab('header')">Header</div>
                <div class="tab" onclick="showTab('acknowledgements')">Acknowledgements</div>
            </div>
            
            <div id="summary" class="tab-content active">
                <h3>Executive Summary</h3>
                <p>This interactive report provides comprehensive pharmacogenomic information based on the sample's genetic analysis.</p>

                <!-- Disclaimer card moved to the top of Summary tab -->
                <div class="card">
                    <h4>Disclaimer</h4>
                    <p style="margin:0;">{{ disclaimer }}</p>
                </div>
                
                <h4>Key Findings</h4>
                <div class="grid">
                    {% for d in diplotypes|sort(attribute='gene') %}
                    <div class="card">
                        <h3>{{ d.gene }}</h3>
                        <p><strong>Diplotype:</strong> {{ d.diplotype }}</p>
                        <p>
                            <strong>Phenotype:</strong> 
                            <span class="gene-phenotype {% if d.phenotype and 'Likely Wild Type' in d.phenotype %}likely-wild-type{% elif d.phenotype and 'Possibly Wild Type' in d.phenotype %}possibly-wild-type{% elif d.phenotype and 'Normal' in d.phenotype %}normal-metabolizer{% elif d.phenotype and 'Poor' in d.phenotype %}poor-metabolizer{% elif d.phenotype and 'Intermediate' in d.phenotype %}intermediate-metabolizer{% elif d.phenotype and ('Rapid' in d.phenotype or 'Ultrarapid' in d.phenotype) %}rapid-metabolizer{% endif %}">
                                {{ d.phenotype or 'Unknown' }}
                            </span>
                        </p>
                        <p>
                            <strong>Clinical Impact:</strong>
                            {% if d.phenotype and 'Normal' in d.phenotype %}
                                Standard drug metabolism expected for medications metabolized by {{ d.gene }}.
                            {% elif d.phenotype and 'Poor' in d.phenotype %}
                                Reduced drug metabolism may require dose adjustments for medications metabolized by {{ d.gene }}.
                            {% elif d.phenotype and 'Intermediate' in d.phenotype %}
                                Slightly reduced metabolism may require monitoring for medications metabolized by {{ d.gene }}.
                            {% elif d.phenotype and ('Rapid' in d.phenotype or 'Ultrarapid' in d.phenotype) %}
                                Increased metabolism may reduce efficacy at standard doses for medications metabolized by {{ d.gene }}.
                            {% else %}
                                Consult clinical guidelines for medications metabolized by {{ d.gene }}.
                            {% endif %}
                        </p>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Gene Phenotypes chart (restored) -->
                <div class="chart-container">
                    <h4>Gene Phenotypes</h4>
                    <canvas id="genePhenotypeChart"></canvas>
                </div>

                
            </div>
            
            <div id="genes" class="tab-content">
                <h3>Genetic Results</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Gene</th>
                            <th>Diplotype</th>
                            <th>Phenotype</th>
                            <th>Activity Score</th>
                            <th>Implications</th>
                            <th class="narrow-col">Call</th>
                            <th class="narrow-col">Data</th>
                            <th class="narrow-col">Guide</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in diplotypes|sort(attribute='gene') %}
                        <tr>
                            <td>{{ d.gene }}</td>
                            <td>{{ d.diplotype }}</td>
                            <td>
                                <span class="gene-phenotype {% if d.phenotype and 'Likely Wild Type' in d.phenotype %}likely-wild-type{% elif d.phenotype and 'Possibly Wild Type' in d.phenotype %}possibly-wild-type{% elif d.phenotype and 'Normal' in d.phenotype %}normal-metabolizer{% elif d.phenotype and 'Poor' in d.phenotype %}poor-metabolizer{% elif d.phenotype and 'Intermediate' in d.phenotype %}intermediate-metabolizer{% elif d.phenotype and ('Rapid' in d.phenotype or 'Ultrarapid' in d.phenotype) %}rapid-metabolizer{% endif %}">
                                    {{ d.phenotype or 'Unknown' }}
                                </span>
                            </td>
                            <td>{{ d.activity_score if d.activity_score else '' }}</td>
                            <td>
                                {% if d.phenotype and 'Normal' in d.phenotype %}
                                    Standard drug metabolism expected
                                {% elif d.phenotype and 'Poor' in d.phenotype %}
                                    Reduced drug metabolism may require dose adjustments
                                {% elif d.phenotype and 'Intermediate' in d.phenotype %}
                                    Slightly reduced metabolism may require monitoring
                                {% elif d.phenotype and ('Rapid' in d.phenotype or 'Ultrarapid' in d.phenotype) %}
                                    Increased metabolism may reduce efficacy at standard doses
                                {% else %}
                                    Consult clinical guidelines
                                {% endif %}
                            </td>
                            <td class="narrow-col">{{ d.called_by if d.called_by else '' }}</td>
                            <td class="narrow-col">{{ d.report_data_from if d.report_data_from else '' }}</td>
                            <td class="narrow-col">{{ d.guideline_source if d.guideline_source else '' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <div class="tool-key">
                    <h4>Source Legend:</h4>
                    <p><strong>Call:</strong> Calling tool - <strong>P</strong> = PyPGx, <strong>C</strong> = PharmCAT, <strong>O</strong> = OptiType, <strong>M</strong> = mtDNA-server-2, <strong>G</strong> = GATK</p>
                    <p><strong>Data:</strong> Report data tool - <strong>C</strong> = PharmCAT, <strong>P</strong> = PyPGx</p>
                    <p><strong>Guide:</strong> Guideline source - <strong>F</strong> = FDA, <strong>D</strong> = DPWG, <strong>C</strong> = CPIC, <strong>P</strong> = PharmGKB</p>
                </div>
                
                <div id="geneInfoSection"></div>
            </div>
            
            <div id="drugs" class="tab-content">
                <h3>Drugs</h3>
                <p>The following drugs have pharmacogenomic guidance available based on this sample's genetic profile:</p>
                
                <div class="evidence-legend">
                    <p><strong>Evidence Level Legend:</strong></p>
                    <div class="legend-items">
                        <span class="legend-item evidence-3"><span class="drug-indicator"></span> High actionability (Level A/Strong)</span>
                        <span class="legend-item evidence-2"><span class="drug-indicator"></span> Moderate actionability (Level B/Moderate)</span>
                        <span class="legend-item evidence-1"><span class="drug-indicator"></span> Informational (Level C/Optional)</span>
                        <span class="legend-item evidence-0"><span class="drug-indicator"></span> Guideline available</span>
                    </div>
                </div>
                
                {% set grouped_recommendations = {} %}
                {% for rec in recommendations %}
                    {% set drug_name = rec.drug %}
                    {% if drug_name not in grouped_recommendations %}
                        {% set _ = grouped_recommendations.update({drug_name: []}) %}
                    {% endif %}
                    {% set _ = grouped_recommendations[drug_name].append(rec) %}
                {% endfor %}
                
                <div class="drugs-grid-interactive">
                    {% for drug_name in grouped_recommendations.keys()|sort %}
                        {% set drug_recs = grouped_recommendations[drug_name] %}
                        {% set ns = namespace(max_evidence=0) %}
                        {% set debug_classifications = [] %}
                        {% for rec in drug_recs %}
                            {% set classification = (rec.classification or '') %}
                            {% set _ = debug_classifications.append(classification) %}
                            {% set classification_upper = classification.upper() %}
                            {% if 'STRONG' in classification_upper or classification_upper == 'A' or 'LEVEL A' in classification_upper or 'ACTIONABLE' in classification_upper %}
                                {% set evidence = 3 %}
                            {% elif 'MODERATE' in classification_upper or classification_upper == 'B' or 'LEVEL B' in classification_upper %}
                                {% set evidence = 2 %}
                            {% elif 'OPTIONAL' in classification_upper or classification_upper == 'C' or 'LEVEL C' in classification_upper or 'INFORMATIONAL' in classification_upper or 'WEAK' in classification_upper %}
                                {% set evidence = 1 %}
                            {% else %}
                                {% set evidence = 0 %}
                            {% endif %}
                            {% if evidence > ns.max_evidence %}
                                {% set ns.max_evidence = evidence %}
                            {% endif %}
                        {% endfor %}
                        <!-- DEBUG: {{ drug_name }}: classifications=[{{ debug_classifications|join(', ') }}], max_evidence={{ ns.max_evidence }} -->
                        <a href="#drug-rec-{{ drug_name|lower|replace(' ', '-') }}" class="drug-item-interactive-link" onclick="switchToRecsTab(event); return false;">
                            <div class="drug-item-interactive evidence-{{ ns.max_evidence }}" title="{{ drug_name|title }}: Evidence Level {{ ns.max_evidence }} | Classifications: {{ debug_classifications|join(', ') }}">
                                <span class="drug-indicator"></span>
                                <span class="drug-name">{{ drug_name|title }}</span>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            </div>
            
            <div id="recs" class="tab-content">
                <h3>Drug Recommendations</h3>
                <p>Detailed pharmacogenomic recommendations based on CPIC, DPWG, and FDA guidelines:</p>
                
                {% set grouped_recommendations = {} %}
                {% for rec in recommendations %}
                    {% set drug_name = rec.drug %}
                    {% if drug_name not in grouped_recommendations %}
                        {% set _ = grouped_recommendations.update({drug_name: []}) %}
                    {% endif %}
                    {% set _ = grouped_recommendations[drug_name].append(rec) %}
                {% endfor %}
                
                <div class="recs-list">
                    {% for drug_name in grouped_recommendations.keys()|sort %}
                        {% set drug_recs = grouped_recommendations[drug_name] %}
                        
                        {# Calculate max evidence level for this drug #}
                        {% set ns = namespace(max_evidence=0) %}
                        {% for rec in drug_recs %}
                            {% set classification = (rec.classification or '') %}
                            {% set classification_upper = classification.upper() %}
                            {% if 'STRONG' in classification_upper or classification_upper == 'A' or 'LEVEL A' in classification_upper or 'ACTIONABLE' in classification_upper %}
                                {% set evidence = 3 %}
                            {% elif 'MODERATE' in classification_upper or classification_upper == 'B' or 'LEVEL B' in classification_upper %}
                                {% set evidence = 2 %}
                            {% elif 'OPTIONAL' in classification_upper or classification_upper == 'C' or 'LEVEL C' in classification_upper or 'INFORMATIONAL' in classification_upper or 'WEAK' in classification_upper %}
                                {% set evidence = 1 %}
                            {% else %}
                                {% set evidence = 0 %}
                            {% endif %}
                            {% if evidence > ns.max_evidence %}
                                {% set ns.max_evidence = evidence %}
                            {% endif %}
                        {% endfor %}
                        
                        <div class="card drug-card drug-rec-target evidence-{{ ns.max_evidence }}" id="drug-rec-{{ drug_name|lower|replace(' ', '-') }}">
                            <h3>{{ drug_name|title }}</h3>
                            {% set recommendation_groups = {} %}
                            {% for rec in drug_recs %}
                                {% set rec_key = (rec.recommendation or '') + "|" + (rec.classification or '') + "|" + (rec.guideline_source if rec.guideline_source else 'General') %}
                                {% if rec_key not in recommendation_groups %}
                                    {% set _ = recommendation_groups.update({rec_key: {'rec': rec, 'genes': []}}) %}
                                {% endif %}
                                {% set _ = recommendation_groups[rec_key]['genes'].append(rec.gene) %}
                            {% endfor %}
                            
                            {% for rec_key, group_data in recommendation_groups.items() %}
                                {% set classification = (group_data['rec'].classification or '') %}
                                {% set classification_upper = classification.upper() %}
                                {% if 'STRONG' in classification_upper or classification_upper == 'A' or 'LEVEL A' in classification_upper or 'ACTIONABLE' in classification_upper %}
                                    {% set rec_evidence = 3 %}
                                {% elif 'MODERATE' in classification_upper or classification_upper == 'B' or 'LEVEL B' in classification_upper %}
                                    {% set rec_evidence = 2 %}
                                {% elif 'OPTIONAL' in classification_upper or classification_upper == 'C' or 'LEVEL C' in classification_upper or 'INFORMATIONAL' in classification_upper or 'WEAK' in classification_upper %}
                                    {% set rec_evidence = 1 %}
                                {% else %}
                                    {% set rec_evidence = 0 %}
                                {% endif %}
                                <div class="gene-recommendation evidence-{{ rec_evidence }}" style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                                    <h4 style="margin: 0 0 8px 0; color: #495057;">{{ group_data['genes']|join(', ') }} - {{ group_data['rec'].guideline_source if group_data['rec'].guideline_source else 'General' }}</h4>
                                    <p style="margin: 4px 0;"><strong>Recommendation:</strong> {{ group_data['rec'].recommendation }}</p>
                                    <p style="margin: 4px 0;"><strong>Strength of Evidence:</strong> {{ group_data['rec'].classification }}</p>
                                    {% if group_data['rec'].literature_references %}
                                    <p style="margin: 4px 0;"><strong>References:</strong> {{ group_data['rec'].literature_references|join(", ") }}</p>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <div id="visualizations" class="tab-content">
                <h3>Interactive Visualizations</h3>
                <div class="chart-container">
                    <h4>Drug-Gene Interaction Network</h4>
                    <div id="networkVisualization"></div>
                </div>
                
                <div class="chart-container">
                    <h4>Drug Recommendations by Risk</h4>
                    <canvas id="recommendationChart"></canvas>
                </div>
            </div>

            <div id="method" class="tab-content">
                <h3>Method</h3>
                <div class="card" style="page-break-inside: avoid;">
                    <h4>Software Platform</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Version</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if platform_info and platform_info|length > 0 %}
                                {% for item in platform_info %}
                                <tr>
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.version }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="2">Not available</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="card" style="page-break-inside: avoid;">
                    <h4>Methodology</h4>
                    <p>The sample's genetic data were analyzed using PharmCAT (Pharmacogenomics Clinical Annotation Tool), which references CPIC (Clinical Pharmacogenetics Implementation Consortium) guidelines. Genetic variants were processed to identify star alleles and diplotypes, which were then mapped to phenotypes and matched with relevant recommendations.</p>
                </div>
                <div class="card workflow-section" style="page-break-inside: avoid; break-inside: avoid;">
                    <h4>Workflow</h4>
                    
                    <!-- Primary Workflow Diagram (Mermaid preferred, Graphviz fallback) -->
                    <div class="workflow-figure">
                        {% if workflow_kroki_svg %}
                          <!-- Prefer Mermaid diagram -->
                          {{ workflow_kroki_svg | safe }}
                        {% elif workflow_png_url %}
                          <!-- Fallback to PNG file -->
                          <img src="{{ workflow_png_url }}" alt="Workflow Diagram" />
                        {% elif workflow_png_data_uri %}
                          <!-- Fallback to PNG data URI -->
                          <img src="{{ workflow_png_data_uri }}" alt="Workflow Diagram" />
                        {% elif workflow_svg %}
                          <!-- Fallback to Graphviz SVG -->
                          {{ workflow_svg | safe }}
                        {% elif workflow_html_fallback %}
                          <!-- Fallback to HTML -->
                          {{ workflow_html_fallback | safe }}
                        {% else %}
                          <!-- Hard fail-safe directly in template -->
                          <div class="workflow-text">
                            <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>Upload</span>
                            <span style='color:#5b8def;font-size:14px'>&nbsp;→&nbsp;</span>
                            <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>Detect</span>
                            <span style='color:#5b8def;font-size:14px'>&nbsp;→&nbsp;</span>
                            <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>VCF</span>
                            <span style='color:#5b8def;font-size:14px'>&nbsp;→&nbsp;</span>
                            <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>PharmCAT</span>
                            <span style='color:#5b8def;font-size:14px'>&nbsp;→&nbsp;</span>
                            <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>Reports</span>
                          </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div id="export" class="tab-content">
                <h3>Export to Electronic Health Record</h3>
                <p>FHIR export functionality is currently under construction. You can access the HAPI FHIR server directly for testing and development purposes.</p>

                <div class="card">
                    <div style="text-align: center; padding: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--warning-color);">🚧 Under Construction 🚧</h4>
                        <p style="margin-bottom: 20px;">The FHIR export feature is being developed. For now, you can access the HAPI FHIR server directly.</p>
                        <a href="http://localhost:8090"
                           target="_blank"
                           class="btn btn-primary"
                           style="padding: 12px 24px; font-size: 16px;">
                            Open HAPI FHIR Server
                        </a>
                        <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                            HAPI FHIR Server is available at: <code>http://localhost:8090</code>
                        </p>
                    </div>
                </div>
            </div>

            <div id="header" class="tab-content">
                <h3>Genomic Datafile Header</h3>
                <p class="header-note">The submitted genomic datafile's header matter is reproduced below. Please note that if any conversion or re-alignment operations were performed, the header information below does not reflect that; the header from the original uploaded file is what is shown.</p>
                {% if header_text %}
                <pre class="file-header">{{ header_text|e }}</pre>
                {% else %}
                <div class="card">
                    <p>No header text was found for this submission.</p>
                </div>
                {% endif %}
            </div>

            <div id="acknowledgements" class="tab-content">
                <h3>Acknowledgements</h3>
                <div class="card">
                    <h4>Citations</h4>
                    <ul>
                        {% if citations and citations|length > 0 %}
                            {% for c in citations %}
                            <li>{{ c.text }}</li>
                            {% endfor %}
                        {% else %}
                            <li>Not available</li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card" style="page-break-inside: avoid;">
                    <h4>PharmCAT</h4>
                    <p>We acknowledge the use of PharmCAT (Pharmacogenomics Clinical Annotation Tool) for gene-level interpretations and recommendations.</p>
                    <ul>
                        <li>Sangkuhl K, Whirl-Carrillo M, et al. Pharmacogenomics Clinical Annotation Tool (PharmCAT). <em>Clinical Pharmacology &amp; Therapeutics</em>. 2020;107(1):203–210. See also the <a href="https://pharmcat.clinpgx.org/faqs/#create-ones-own-pdf-report-based-on-the-pharmcat-json-file" target="_blank" rel="noopener">PharmCAT FAQ</a>.</li>
                    </ul>
                </div>
                <div class="card" style="page-break-inside: avoid;">
                    <h4>GATK</h4>
                    <p>We acknowledge the use of the Genome Analysis Toolkit (GATK) for variant discovery.</p>
                    <ul>
                        <li>McKenna A, et al. The Genome Analysis Toolkit: a MapReduce framework for analyzing next-generation DNA sequencing data. <em>Genome Research</em>. 2010;20(9):1297–1303.</li>
                        <li>DePristo MA, et al. A framework for variation discovery and genotyping using next-generation DNA sequencing data. <em>Nature Genetics</em>. 2011;43(5):491–498.</li>
                    </ul>
                    <p class="small">Additional guidance: <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035530852-How-should-I-cite-GATK-in-my-own-publications" target="_blank" rel="noopener">How to cite GATK</a>.</p>
                </div>
                <div class="card" style="page-break-inside: avoid;">
                    <h4>PyPGx</h4>
                    <p>We acknowledge the use of PyPGx for star‑allele calling.</p>
                    <ul>
                        <li>Lee S‑B, et&nbsp;al. ClinPharmSeq: A targeted sequencing panel for clinical pharmacogenetics implementation. <em>PLOS ONE</em>. 2022.</li>
                        <li>Lee S‑B, et&nbsp;al. Stargazer: a software tool for calling star alleles from next‑generation sequencing data using CYP2D6 as a model. <em>Genetics in Medicine</em>. 2018.</li>
                        <li>Lee S‑B, et&nbsp;al. Calling star alleles with Stargazer in 28 pharmacogenes with whole‑genome sequences. <em>Clinical Pharmacology &amp; Therapeutics</em>. 2019.</li>
                    </ul>
                </div>
            </div>
        </div>
        
        
    </div>
    
    <footer>
        <p>&copy; 2024-{{ current_year }} {{ author_name or 'Unknown Author' }}</p>
        <p>This program is licensed under the <a href="{{ license_url }}" target="_blank" rel="noopener">{{ license_name }}</a>.</p>
        <p>Source code: <a href="{{ source_url }}" target="_blank" rel="noopener">{{ source_url }}</a>.</p>
    </footer>
    <!-- Debug veneer: remove in production -->
    {% if debug_json %}
    <pre style="white-space: pre-wrap; font-size: 10px; color: #666; background: #f7f7f7; border: 1px dashed #ccc; padding: 8px; margin-top: 12px;">
{{ debug_json }}
    </pre>
    {% endif %}
    
    <!-- Store report data in a hidden element for JavaScript to access -->
    <div id="pgxData" 
         data-patient-id="{{ patient_id }}"
         data-report-id="{{ report_id }}"
         data-report-date="{{ report_date }}"
         data-organized-recommendations="{{ organized_recommendations|tojson|safe }}"
         style="display:none;">
        
        <!-- Store diplotypes data -->
        {% for d in diplotypes %}
        <div class="diplotype-data"
             data-gene="{{ d.gene }}"
             data-diplotype="{{ d.diplotype }}"
             data-phenotype="{{ d.phenotype }}"
             data-activity-score="{{ d.activity_score if d.activity_score else '' }}">
        </div>
        {% endfor %}
        
        <!-- Store recommendations data -->
        {% for rec in recommendations %}
        <div class="recommendation-data"
             data-drug="{{ rec.drug }}"
             data-gene="{{ rec.gene }}"
             data-recommendation="{{ rec.recommendation }}"
             data-classification="{{ rec.classification }}"
             data-literature-references="{{ rec.literature_references|tojson|safe if rec.literature_references else '[]' }}">
        </div>
        {% endfor %}
    </div>
    
    <!-- Tab switching function for drug links -->
    <script>
        function switchToRecsTab(event) {
            // Prevent default anchor behavior
            if (event) {
                event.preventDefault();
            }
            
            // Get the target drug ID from the clicked link
            var targetId = event ? event.currentTarget.getAttribute('href').substring(1) : null;
            
            // Switch to Recs tab
            showTab('recs');
            
            // Wait for tab content to be visible, then scroll to the drug
            setTimeout(function() {
                if (targetId) {
                    var targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'nearest'
                        });
                        
                        // Add a highlight effect
                        targetElement.style.transition = 'box-shadow 0.3s ease';
                        targetElement.style.boxShadow = '0 0 0 3px rgba(52, 152, 219, 0.5)';
                        setTimeout(function() {
                            targetElement.style.boxShadow = '';
                        }, 2000);
                    }
                }
            }, 100);
        }
    </script>
    
    <!-- External report visualization scripts -->
    <script src="/static/js/pgx-report.js"></script>
    <script src="/static/js/pgx-fhir-export.js"></script>
</body>
</html> 