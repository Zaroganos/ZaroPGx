<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZaroPGx - Pharmacogenomics Platform</title>
    <!-- Favicon references -->
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="shortcut icon" href="/static/favicon.png">
    <link rel="apple-touch-icon" href="/static/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script>
        (function() {
            try {
                const storedTheme = localStorage.getItem('zpgx-theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = storedTheme || (prefersDark ? 'dark' : 'light');
                document.documentElement.setAttribute('data-bs-theme', theme);
            } catch (e) {
                document.documentElement.setAttribute('data-bs-theme', 'light');
            }
        })();
    </script>
    <style>
        :root {
            color-scheme: light;
            --header-bg: #0066cc;
            --header-text: #ffffff;
            --footer-bg: #f8f9fa;
            --card-header-bg: #0066cc;
            --card-header-text: #ffffff;
        }
        [data-bs-theme='dark'] {
            color-scheme: dark;
            --header-bg: #0b3d91;
            --header-text: #e6e6e6;
            --footer-bg: #0f172a;
            --card-header-bg: #0b3d91;
            --card-header-text: #e6e6e6;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 20px;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        .header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 1.25rem 1rem;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
        }
        .header-inner {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 1rem;
        }
        .header-icon-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-color: rgba(255, 255, 255, 0.65) !important;
            color: var(--header-text) !important;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }
        .header-icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: var(--card-header-bg);
            color: var(--card-header-text);
            font-weight: bold;
        }
        .footer {
            margin-top: 3rem;
            padding: 1.5rem 0;
            background-color: var(--footer-bg);
            text-align: center;
        }
        .stage-indicator {
            position: relative;
            padding: 0 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 8px;
            border: 2px solid transparent;
            z-index: 1;
        }
        
        .stage-indicator:hover {
            background-color: rgba(0, 123, 255, 0.1);
            border-color: rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .stage-indicator.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .stage-indicator.disabled:hover {
            background-color: rgba(108, 117, 125, 0.1);
            border-color: rgba(108, 117, 125, 0.3);
            transform: none;
        }
        
        /* Stage popup tooltip */
        .stage-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            min-width: 280px;
            max-width: 320px;
            z-index: 9999;
            margin-top: 8px;
            display: none;
        }
        
        .stage-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        
        .stage-popup::after {
            content: '';
            position: absolute;
            top: -9px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-bottom: 9px solid #dee2e6;
        }
        
        .stage-popup h6 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .stage-popup p {
            margin: 0 0 12px 0;
            color: #6c757d;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .stage-popup .toggle-section {
            border-top: 1px solid #e9ecef;
            padding-top: 12px;
            margin-top: 12px;
        }
        
        .stage-popup .toggle-button {
            width: 100%;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .stage-popup .toggle-button:hover {
            background: #e9ecef;
        }
        
        .stage-popup .toggle-button.enabled {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .stage-popup .toggle-button.disabled {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        /* Removing connector lines
        .stage-indicator:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 25%;
            right: -12px;
            width: 24px;
            height: 2px;
            background-color: #dee2e6;
            transition: background-color 0.3s ease;
        }
        */
        /* Apply color styling to both icons and text */
        .stage-indicator.text-primary i,
        .stage-indicator.text-primary span {
            color: var(--bs-primary) !important;
        }
        .stage-indicator.text-success i,
        .stage-indicator.text-success span {
            color: var(--bs-success) !important;
        }
        /* Removing connector line coloring
        .stage-indicator.text-success::after {
            background-color: #198754;
        }
        .stage-indicator.text-primary::after {
            background-color: #0066cc;
        }
        */
        /* Ensure all stage icons have consistent size */
        .stage-indicator i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        /* Header display area styling */
        #headerDisplay {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }

        #headerContent {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        #headerContent .table {
            margin-bottom: 0;
            font-size: 0.875rem;
        }

        #headerContent .table td {
            word-break: break-all;
            max-width: 200px;
        }

        #headerContent .alert {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        #headerContent .alert ul {
            margin-bottom: 0;
            padding-left: 1.5rem;
        }

        #headerContent .alert li {
            word-break: break-word;
            margin-bottom: 0.25rem;
        }


        /* Dark mode support for inner cards */
        [data-bs-theme='dark'] #headerContent .card.bg-light {
            background-color: #374151 !important;
            border-color: rgba(255, 255, 255, 0.125);
        }

        [data-bs-theme='dark'] #headerContent .text-muted {
            color: #9ca3af !important;
        }

        /* Responsive design for header display */
        @media (max-width: 768px) {
            #headerContent .table td {
                max-width: 120px;
                font-size: 0.8rem;
            }

            #headerContent .row > div {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-inner">
                <div class="header-left d-flex">
                    <a href="/" class="btn btn-outline-light header-icon-btn" aria-label="Home" title="Home">
                        <i class="bi bi-house-door-fill"></i>
                    </a>
                </div>
                <div class="header-center text-center">
                    <h1 class="mb-0">ZaroPGx</h1>
                    <p class="lead mb-0">Pharmacogenomics Analysis Platform</p>
                </div>
                <div class="header-right d-flex justify-content-end">
                    <button id="themeToggle" class="btn btn-outline-light header-icon-btn" aria-label="Toggle theme" title="Toggle theme">
                        <i id="themeIcon" class="bi bi-moon-stars-fill"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8 offset-md-2">
                <!-- Login Form (shown by default) -->
                <div id="loginForm" class="card mb-4 d-none">
                    <div class="card-header">Login</div>
                    <div class="card-body">
                        <form id="authForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Login</button>
                        </form>
                    </div>
                </div>

                <!-- Main Content (hidden until logged in) -->
                <div id="mainContent">
                <!-- Display messages if any -->
                {% if message %}
                <div class="alert {{ 'alert-success' if success else 'alert-danger' }}" role="alert">
                    {{ message }}
                    {% if success and report_id %}
                    <div class="mt-3">
                        <p>Your report is ready!</p>
                        <a href="{{ report_pdf }}" target="_blank" class="btn btn-primary">View PDF Report</a>
                        <a href="{{ report_html }}" target="_blank" class="btn btn-info">View Interactive Report</a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Service status alert - shown only if services are down -->
                {% if service_alert %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <div>
                            <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>Service Issue Detected</strong>
                            <span> - {{ service_alert }}</span>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                <div class="card">
                    <div class="card-header">Upload Genomic File for Analysis</div>
                    <div class="card-body">
                            <form action="/upload/genomic-data" method="post" enctype="multipart/form-data" id="uploadForm">
                            <div class="mb-3">
                                <label for="genomicFile" class="form-label">Genomic File</label>
                                    <input class="form-control" type="file" id="genomicFile" name="file" accept=".vcf,.vcf.gz,.bam,.sam,.cram,.fastq,.fastq.gz,.fq,.fq.gz,.txt,.csv,.zip" required>
                                    <div class="form-text">Upload FASTQ, BAM, SAM, CRAM, or VCF genomic datafile(s) for pharmacogenomic analysis. Support for 23andMe and BED is coming soon.</div>
                            </div>
                                
                            <div class="mb-3">
                                    <label for="sampleIdentifier" class="form-label">Sample Identifier (Optional)</label>
                                    <input type="text" class="form-control" id="sampleIdentifier" name="sample_identifier" placeholder="Enter a sample identifier">
                                </div>


                                
                                <!-- File Analysis Results (hidden by default) -->
                                <div id="fileAnalysis" class="mb-3 d-none">
                                    <h5>File Analysis</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <div id="fileTypeInfo" class="mb-2"></div>
                                            <div id="vcfInfo" class="mb-2 d-none"></div>
                                            <div id="workflowInfo" class="mb-2"></div>
                                            <div id="warnings" class="alert alert-warning d-none"></div>
                                        </div>
                                    </div>
                            </div>
                            
                            <!-- Stage indicators (always visible) -->
                            <div class="d-flex justify-content-between small mb-3" style="overflow: visible;">
                                <!-- Upload Stage -->
                                <div id="stageUpload" class="stage-indicator text-center text-muted" data-stage="upload" data-toggleable="false">
                                    <div class="mb-1"><i class="bi bi-cloud-upload"></i></div>
                                    <span>Upload</span>
                                    <div class="stage-popup">
                                        <h6>File Upload</h6>
                                        <p>Upload your genomic data file (VCF, BAM, etc.) for analysis. This stage is required and cannot be disabled.</p>
                                    </div>
                                </div>
                                
                                <!-- Analysis Stage -->
                                <div id="stageAnalysis" class="stage-indicator text-center text-muted" data-stage="analysis" data-toggleable="false">
                                    <div class="mb-1"><i class="bi bi-search"></i></div>
                                    <span>Analysis</span>
                                    <div class="stage-popup">
                                        <h6>File Analysis</h6>
                                        <p>Inspect and analyze the uploaded file format, quality, and content. This stage is required and cannot be disabled.</p>
                                    </div>
                                </div>
                                
                                <!-- OptiType Stage -->
                                <div id="stageHLA" class="stage-indicator text-center text-muted" data-stage="hla" data-toggleable="true" data-enabled="true">
                                    <div class="mb-1"><i class="bi bi-virus2"></i></div>
                                    <span>OptiType</span>
                                    <div class="stage-popup">
                                        <h6>OptiType HLA Typing</h6>
                                        <p>Perform HLA (Human Leukocyte Antigen) typing using OptiType. Computationally intensive but provides immune system insights.</p>
                                        <div class="toggle-section">
                                            <button class="toggle-button enabled" data-stage="hla">✓ Enabled</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- GATK Stage -->
                                <div id="stageGATK" class="stage-indicator text-center text-muted" data-stage="gatk" data-toggleable="true" data-enabled="true">
                                    <div class="mb-1"><i class="bi bi-cpu"></i></div>
                                    <span>GATK</span>
                                    <div class="stage-popup">
                                        <h6>GATK Variant Calling</h6>
                                        <p>Call genetic variants using GATK (Genome Analysis Toolkit). Computationally intensive but provides high-quality variant detection.</p>
                                        <div class="toggle-section">
                                            <button class="toggle-button enabled" data-stage="gatk">✓ Enabled</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- PyPGx Stage -->
                                <div id="stagePyPGx" class="stage-indicator text-center text-muted" data-stage="pypgx" data-toggleable="true" data-enabled="true">
                                    <div class="mb-1"><i class="bi bi-star"></i></div>
                                    <span>PyPGx</span>
                                    <div class="stage-popup">
                                        <h6>PyPGx Star Allele Calling</h6>
                                        <p>Call pharmacogenomic star alleles using PyPGx. Computationally intensive but provides detailed drug metabolism information.</p>
                                        <div class="toggle-section">
                                            <button class="toggle-button enabled" data-stage="pypgx">✓ Enabled</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- PharmCAT Stage -->
                                <div id="stagePharmcat" class="stage-indicator text-center text-muted" data-stage="pharmcat" data-toggleable="false">
                                    <div class="mb-1"><i class="bi bi-capsule"></i></div>
                                    <span>PharmCAT</span>
                                    <div class="stage-popup">
                                        <h6>PharmCAT Analysis</h6>
                                        <p>Generate pharmacogenomic reports using PharmCAT. This stage is required and provides the final analysis results.</p>
                                    </div>
                                </div>
                                
                                <!-- Report Stage -->
                                <div id="stageReport" class="stage-indicator text-center text-muted" data-stage="report" data-toggleable="true" data-enabled="true">
                                    <div class="mb-1"><i class="bi bi-file-earmark-text"></i></div>
                                    <span>Report</span>
                                    <div class="stage-popup">
                                        <h6>Custom Reports</h6>
                                        <p>Generate custom formatted reports with additional visualizations and analysis. When disabled, only PharmCAT's native report is provided.</p>
                                        <div class="toggle-section">
                                            <button class="toggle-button enabled" data-stage="report">✓ Enabled</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Multi-stage progress bar (hidden by default) -->
                            <div id="progressContainer" class="mb-3 d-none">
                                <label class="form-label" id="progressLabel">Progress</label>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                        0%
                                    </div>
                                </div>
                                <div id="progressStatus" class="form-text mb-2 fw-bold">Preparing...</div>
                                
                                <!-- Detailed log panel (initially collapsed) -->
                                <div class="card">
                                    <div class="card-header bg-light p-2" role="button" data-bs-toggle="collapse" data-bs-target="#logPanel">
                                        <small class="text-black">Processing Log <i class="bi bi-chevron-down float-end"></i></small>
                                    </div>
                                    <div id="logPanel" class="collapse">
                                        <div id="logMessages" class="card-body p-2 small" style="max-height: 150px; overflow-y: auto; font-family: monospace;">
                                            <!-- Log messages will appear here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Nextflow Process Details (initially collapsed) -->
                                <div id="nextflowProcessPanel" class="card d-none">
                                    <div class="card-header bg-info text-white p-2" role="button" data-bs-toggle="collapse" data-bs-target="#nextflowProcessDetails">
                                        <small class="text-white">
                                            <i class="bi bi-diagram-3 me-1"></i>
                                            Nextflow Process Details 
                                            <span id="nextflowProcessCount" class="badge bg-light text-dark ms-2">0 processes</span>
                                            <i class="bi bi-chevron-down float-end"></i>
                                        </small>
                                    </div>
                                    <div id="nextflowProcessDetails" class="collapse">
                                        <div class="card-body p-2">
                                            <div id="nextflowProcessList" class="small">
                                                <!-- Process details will appear here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary" id="uploadButton">Upload</button>

                                <!-- View Header button -->
                                <button type="button" class="btn btn-info" id="viewHeaderButton" onclick="viewHeader()">
                                    <i class="bi bi-eye"></i> View Header
                                </button>

                                <!-- Demo button for PharmCAT example -->
                                <button type="button" class="btn btn-secondary" id="demoButton" onclick="runPharmCatDemo()" title="Run Demo with PharmCAT VCF">
                                    <i class="bi bi-play-fill"></i> Run Demo
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                    <!-- Header Display Area -->
                    <div id="headerDisplay" class="card mt-4 d-none">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-file-earmark-text me-2"></i>
                                File Header Information
                            </h5>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="viewHeader()" title="Hide header information">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="headerContent" class="container-fluid">
                                <!-- Header content will be displayed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Results Container -->
                    <div id="analysisResults" class="card mt-4 d-none">
                        <div class="card-header">Analysis Results</div>
                        <div class="card-body">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>

                <div class="row align-items-stretch">
                    <div class="col-md-6 d-flex">
                        <div class="card h-100 w-100">
                            <div class="card-header">ZaroPgx Documentation</div>
                            <div class="card-body d-flex flex-column h-100">
                                <p class="mb-0">ZaroPGx is a free and open, easily self-hostable pharmacogenomic
                                    analysis system which attempts to create the most accurate and complete reports possible 
                                    with a given genomic datafile.
                                    
                                    See the software documentation, and access the API reference.</p>
                                <div class="mt-auto d-flex gap-2">
                                    <a href="/documentation/" class="btn btn-secondary">Documentation</a>
                                    <a href="/api-reference" class="btn btn-outline-secondary">API Reference</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mt-3 mt-md-0 d-flex">
                        <div class="card h-100 w-100">
                            <div class="card-header">About PharmCAT</div>
                            <div class="card-body d-flex flex-column h-100">
                                <p>This platform uses PharmCAT to generate recommendations based on institutional guidelines.

                                    PharmCAT is now a part of the ClinPGx project, which also includes CPIC and PharmGKB.

                                    For a full list of software comprising ZaroPGx, please see the documentation.
                                </p>
                                <div class="mt-auto d-flex gap-2">
                                    <a href="https://pharmcat.org/" target="_blank" class="btn btn-secondary">Learn More</a>
                                    <a href="https://www.clinpgx.org/" target="_blank" class="btn btn-outline-secondary">ClinPGx</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer small">
            <p class="mb-1">&copy; 2024-{{ current_year }} {{ author_name or 'Unknown Author' }}</p>
            <p class="mb-1">This program is licensed under the <a href="{{ license_url }}" target="_blank" rel="noopener">{{ license_name }}</a>.</p>
            <p class="mb-0">Source code: <a href="{{ source_url }}" target="_blank" rel="noopener">{{ source_url }}</a>. Provided without warranty; see license for details.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Add JavaScript file for upload progress tracking -->
    <script src="/static/js/GenomeDownloadProgress.js"></script>
    
    <!-- Add JavaScript for real progress tracking using Server-Sent Events -->
    <script>
        // Theme toggle
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            function setTheme(theme) {
                document.documentElement.setAttribute('data-bs-theme', theme);
                try { localStorage.setItem('zpgx-theme', theme); } catch (e) {}
                if (themeIcon) {
                    themeIcon.className = theme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
                }
                if (themeToggle) {
                    const label = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
                    themeToggle.setAttribute('aria-label', label);
                    themeToggle.title = label;
                }
            }
            const stored = (function(){ try { return localStorage.getItem('zpgx-theme'); } catch(e) { return null; } })();
            const initial = stored || document.documentElement.getAttribute('data-bs-theme') || 'light';
            setTheme(initial);
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    const current = document.documentElement.getAttribute('data-bs-theme') || 'light';
                    setTheme(current === 'dark' ? 'light' : 'dark');
                });
            }
            if (window.matchMedia) {
                try {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                        const explicit = (function(){ try { return localStorage.getItem('zpgx-theme'); } catch(e) { return null; } })();
                        if (!explicit) {
                            setTheme(e.matches ? 'dark' : 'light');
                        }
                    });
                } catch (e) {}
            }
        });

        // Define accessToken globally so it can be accessed by all functions
        let accessToken = null; // Will be set on page load
        
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const mainContent = document.getElementById('mainContent');
            const authForm = document.getElementById('authForm');
            
            /* 
             * TEMPORARY CHANGE: Skip authentication for development
             * This bypasses login completely during development.
             * Remove this code before production deployment.
             */
            // No token is set - we'll make requests without authentication
            loginForm.classList.add('d-none');
            mainContent.classList.remove('d-none');
            
            // Original authentication code is preserved below for future use
            
            // Function to show main content
            function showMainContent() {
                loginForm.classList.add('d-none');
                mainContent.classList.remove('d-none');
            }

            // Update the file upload handler to work without auth token
            const form = document.getElementById('uploadForm');
            const fileInput = document.getElementById('genomicFile');
            const fileAnalysis = document.getElementById('fileAnalysis');
            const fileTypeInfo = document.getElementById('fileTypeInfo');
            const vcfInfo = document.getElementById('vcfInfo');
            const workflowInfo = document.getElementById('workflowInfo');
            const warnings = document.getElementById('warnings');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            const logMessages = document.getElementById('logMessages');

            // Function to add log message - make it globally available
            window.addLogMessage = function(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `text-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                logMessages.appendChild(logEntry);
                logMessages.scrollTop = logMessages.scrollHeight;
            };

            // Function to update file analysis display - make it globally available
            window.updateFileAnalysis = function(analysis) {
                fileAnalysis.classList.remove('d-none');
                
                // Update file type info
                fileTypeInfo.innerHTML = `
                    <strong>File Type:</strong> ${analysis.file_type}<br>
                    <strong>Compressed:</strong> ${analysis.is_compressed ? 'Yes' : 'No'}<br>
                    <strong>Has Index:</strong> ${analysis.has_index ? 'Yes' : 'No'}
                `;

                // Update VCF info if available
                if (analysis.vcf_info) {
                    vcfInfo.classList.remove('d-none');
                    vcfInfo.innerHTML = `
                        <strong>Reference Genome:</strong> ${analysis.vcf_info.reference_genome}<br>
                        <strong>Sequencing Platform:</strong> ${analysis.vcf_info.sequencing_platform}<br>
                        <strong>Sequencing Profile:</strong> ${analysis.vcf_info.sequencing_profile}<br>
                        <strong>Sample Count:</strong> ${analysis.vcf_info.sample_count}
                    `;
                }

                // Update workflow info
                workflowInfo.innerHTML = `
                    <strong>Analysis Workflow:</strong><br>
                    ${analysis.workflow.recommendations.map(rec => `• ${rec}`).join('<br>')}
                `;

                // Show warnings if any
                if (analysis.workflow.warnings.length > 0) {
                    warnings.classList.remove('d-none');
                    warnings.innerHTML = analysis.workflow.warnings.map(warn => `• ${warn}`).join('<br>');
                }

                // Show progress container
                progressContainer.classList.remove('d-none');
            };

            // Make monitorProgress globally available
            window.monitorProgress = async function(jobId) {
                const progressBar = document.getElementById('progressBar');
                const progressStatus = document.getElementById('progressStatus');
                const uploadButton = document.getElementById('uploadButton');
                const logMessages = document.getElementById('logMessages');
                
                // Check if elements exist before proceeding
                if (!progressBar || !progressStatus || !logMessages) {
                    console.error("Progress monitoring elements not found");
                    return;
                }

                const addLogMessage = (message, type = 'info') => {
                    if (!logMessages) return;
                    const timestamp = new Date().toLocaleTimeString();
                    const logEntry = document.createElement('div');
                    logEntry.className = `text-${type}`;
                    logEntry.textContent = `[${timestamp}] ${message}`;
                    logMessages.appendChild(logEntry);
                    logMessages.scrollTop = logMessages.scrollHeight;
                };

                const updateNextflowProcessDetails = (processes) => {
                    const nextflowPanel = document.getElementById('nextflowProcessPanel');
                    const processCount = document.getElementById('nextflowProcessCount');
                    const processList = document.getElementById('nextflowProcessList');
                    
                    if (!nextflowPanel || !processCount || !processList) return;
                    
                    // Show the panel if it's hidden
                    nextflowPanel.classList.remove('d-none');
                    
                    // Update process count
                    const totalProcesses = Object.keys(processes).length;
                    processCount.textContent = `${totalProcesses} processes`;
                    
                    // Clear existing process list
                    processList.innerHTML = '';
                    
                    // Add each process
                    Object.entries(processes).forEach(([taskId, process]) => {
                        const processDiv = document.createElement('div');
                        processDiv.className = 'mb-2 p-2 border rounded';
                        
                        // Determine status color and icon
                        let statusClass = 'text-muted';
                        let statusIcon = 'bi-circle';
                        let statusText = process.status || 'Unknown';
                        
                        switch (process.status) {
                            case 'SUBMITTED':
                                statusClass = 'text-info';
                                statusIcon = 'bi-clock';
                                break;
                            case 'RUNNING':
                                statusClass = 'text-primary';
                                statusIcon = 'bi-play-circle';
                                break;
                            case 'COMPLETED':
                                statusClass = 'text-success';
                                statusIcon = 'bi-check-circle';
                                break;
                            case 'FAILED':
                                statusClass = 'text-danger';
                                statusIcon = 'bi-x-circle';
                                break;
                            case 'CANCELLED':
                                statusClass = 'text-warning';
                                statusIcon = 'bi-stop-circle';
                                break;
                        }
                        
                        // Format duration
                        let durationText = '';
                        if (process.duration && process.duration !== '-') {
                            const duration = parseFloat(process.duration);
                            if (duration > 60) {
                                durationText = `${Math.round(duration / 60)}m ${Math.round(duration % 60)}s`;
                            } else {
                                durationText = `${Math.round(duration)}s`;
                            }
                        }
                        
                        // Format timestamps
                        const formatTime = (timeStr) => {
                            if (!timeStr || timeStr === '-') return 'N/A';
                            try {
                                return new Date(timeStr).toLocaleTimeString();
                            } catch {
                                return timeStr;
                            }
                        };
                        
                        processDiv.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi ${statusIcon} me-2 ${statusClass}"></i>
                                        <strong class="me-2">${process.process_name || 'Unknown Process'}</strong>
                                        <span class="badge bg-${statusClass.replace('text-', '')}">${statusText}</span>
                                    </div>
                                    <div class="small text-muted">
                                        <div>Task ID: ${taskId}</div>
                                        ${process.tag ? `<div>Tag: ${process.tag}</div>` : ''}
                                        ${durationText ? `<div>Duration: ${durationText}</div>` : ''}
                                        ${process.exit_code && process.exit_code !== '-' ? `<div>Exit Code: ${process.exit_code}</div>` : ''}
                                    </div>
                                </div>
                                <div class="small text-muted text-end">
                                    <div>Start: ${formatTime(process.start_time)}</div>
                                    <div>End: ${formatTime(process.complete_time)}</div>
                                </div>
                            </div>
                        `;
                        
                        processList.appendChild(processDiv);
                    });
                };

                let reconnectAttempt = 0;
                const maxReconnects = 3;

                async function attemptConnection() {
                    try {
                        // Make the request to the new monitoring API
                        const response = await fetch(`/monitoring/progress/${jobId}`, {
                            headers: {
                                'Accept': 'text/event-stream'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();

                        addLogMessage(`Connected to progress stream for job ${jobId}`);
                        reconnectAttempt = 0; // Reset reconnect attempts on successful connection

                        while (true) {
                            try {
                                const {value, done} = await reader.read();
                                
                                if (done) {
                                    console.log("Stream closed normally");
                                    addLogMessage("Progress stream closed normally");
                                    break;
                                }
                                
                                const chunk = decoder.decode(value);
                                const lines = chunk.split('\n');
                                
                                for (const line of lines) {
                                    if (line.trim().length > 0) {
                                        try {
                                            if (line.startsWith('data: ')) {
                                                try {
                                                    const data = JSON.parse(line.slice(6));
                                                    
                                                    // DEBUG: Log all progress data
                                                    console.log("Progress update received:", data);
                                                    
                                                    if (data.reconnect) {
                                                        console.log("Connection timed out, reconnecting...");
                                                        await new Promise(resolve => setTimeout(resolve, 1000));
                                                        attemptConnection();
                                                        return;
                                                    }
                                                    
                                                    // Update progress bar (use 'progress' field instead of 'percent')
                                                    const progressValue = data.progress || data.percent || 0;
                                                    progressBar.style.width = `${progressValue}%`;
                                                    progressBar.textContent = `${progressValue}%`;
                                                    
                                                    // Update status message
                                                    progressStatus.textContent = data.message || '';
                                                    
                                                    // Add log message
                                                    addLogMessage(data.message || 'Processing...');
                                                    
                                                    // Update Nextflow process details if available
                                                    if (data.metadata && data.metadata.nextflow_processes) {
                                                        updateNextflowProcessDetails(data.metadata.nextflow_processes);
                                                    }
                                                    
                                                    // Update stage indicators based on current stage
                                                    if (data.stage) {
                                                        // First, reset all stages to muted
                                                        document.querySelectorAll('.stage-indicator').forEach(el => {
                                                            el.classList.add('text-muted');
                                                            el.classList.remove('text-primary', 'text-success');
                                                        });
                                                        
                                                        // Map backend stage name to frontend stage name
                                                        let currentStage = data.stage;
                                                        // Handle backend stage naming variations
                                                        const stageNameMap = {
                                                            // Upload stages
                                                            'upload_start': 'Upload',
                                                            'upload_complete': 'Upload',
                                                            'initializing': 'Upload',
                                                            'uploaded': 'Upload',
                                                            
                                                            // GATK stages
                                                            'gatk_conversion': 'GATK',
                                                            'fastq_conversion': 'GATK',
                                                            'variant_calling': 'GATK',
                                                            'gatk': 'GATK',
                                                            
                                                            // HLA stages
                                                            'hla_typing': 'HLA',
                                                            'hlatyping': 'HLA',
                                                            'hla': 'HLA',
                                                            
                                                            // PyPGx stages
                                                            'pypgx_analysis': 'PyPGx',
                                                            'pypgx_bam2vcf': 'PyPGx',
                                                            'star_allele_calling': 'PyPGx',
                                                            'pypgx': 'PyPGx',
                                                            
                                                            // PharmCAT stages
                                                            'pharmcat_analysis': 'PharmCAT',
                                                            'pharmcat': 'PharmCAT',
                                                            
                                                            // Report stages
                                                            'workflow_diagram': 'Report',
                                                            'report_generation': 'Report',
                                                            'complete': 'Report',
                                                            'report': 'Report',
                                                            
                                                            // Analysis stages
                                                            'processing': 'Analysis',
                                                            'header_inspection': 'Analysis',
                                                            'analyzing': 'Analysis',
                                                            'analysis': 'Analysis'
                                                        };
                                                        
                                                        // Convert backend stage name to frontend stage name
                                                        if (stageNameMap[currentStage.toLowerCase()]) {
                                                            currentStage = stageNameMap[currentStage.toLowerCase()];
                                                        }
                                                        
                                                        // Map stage to element ID
                                                        const stageMap = {
                                                            'Upload': 'stageUpload',
                                                            'Analysis': 'stageAnalysis',
                                                            'HLA': 'stageHLA',
                                                            'GATK': 'stageGATK', 
                                                            'PyPGx': 'stagePyPGx',
                                                            'PharmCAT': 'stagePharmcat',
                                                            'Report': 'stageReport'
                                                        };
                                                        
                                                        // Get the ordered list of stages for sequencing
                                                        const orderedStages = ['Upload', 'Analysis', 'HLA', 'GATK', 'PyPGx', 'PharmCAT', 'Report'];
                                                        const currentStageIndex = orderedStages.indexOf(currentStage);
                                                        
                                                        console.log("Stage mapping: backend='"+data.stage+"', frontend='"+currentStage+"', index="+currentStageIndex);
                                                        
                                                        if (currentStageIndex !== -1) {
                                                            // Process each stage
                                                            orderedStages.forEach((stageName, index) => {
                                                                const el = document.getElementById(stageMap[stageName]);
                                                                if (el) {
                                                                    // Remove muted styling
                                                                    el.classList.remove('text-muted');
                                                                    
                                                                    if (index < currentStageIndex) {
                                                                        // Completed stages
                                                                        el.classList.add('text-success');
                                                                        el.classList.remove('text-primary');
                                                                    } else if (index === currentStageIndex) {
                                                                        // Current stage
                                                                        el.classList.add('text-primary');
                                                                        el.classList.remove('text-success');
                                                                    } else {
                                                                        // Future stages
                                                                        el.classList.add('text-muted');
                                                                        el.classList.remove('text-success', 'text-primary');
                                                                    }
                                                                }
                                                            });
                                                            
                                                            console.log("Updated stage indicators for stage:", data.stage);
                                                        }
                                                    }
                                                    
                                                    // CRITICAL FIX: If complete, show results
                                                    if (data.complete) {
                                                        console.log("Processing complete:", data);
                                                        
                                                        // Set progress to 100%
                                                        progressBar.style.width = '100%';
                                                        progressBar.textContent = '100%';
                                                        
                                                        // Show completion message
                                                        addLogMessage("✓ Processing complete!", "success");
                                                        
                                                        // Add debug info
                                                        console.log("Complete data:", data);
                                                        
                                                        if (data.success) {
                                                            addLogMessage("✓ Analysis successful", "success");
                                                            console.log("Success data:", data.data);
                                                            console.log("🔍 FULL SUCCESS DATA STRUCTURE:", JSON.stringify(data, null, 2));
                                                            console.log("🔍 PHARMCAT URLS CHECK:");
                                                            console.log("🔍 data.data.pharmcat_html_report_url:", data.data?.pharmcat_html_report_url);
                                                            console.log("🔍 data.data.pharmcat_json_report_url:", data.data?.pharmcat_json_report_url);
                                                            console.log("🔍 data.data.pharmcat_tsv_report_url:", data.data?.pharmcat_tsv_report_url);
                                                            
                                                            // Get report URLs
                                                            let pdfUrl, htmlUrl;
                                                            let pharmcatHtmlUrl, pharmcatJsonUrl, pharmcatTsvUrl;
                                                            
                                                            if (data.data) {
                                                                pdfUrl = data.data.pdf_report_url;
                                                                htmlUrl = data.data.html_report_url;
                                                                pharmcatHtmlUrl = data.data.pharmcat_html_report_url;
                                                                pharmcatJsonUrl = data.data.pharmcat_json_report_url;
                                                                pharmcatTsvUrl = data.data.pharmcat_tsv_report_url;
                                                                console.log("Found report URLs in data.data:", {
                                                                    pdf: pdfUrl,
                                                                    html: htmlUrl,
                                                                    pharmcatHtml: pharmcatHtmlUrl,
                                                                    pharmcatJson: pharmcatJsonUrl,
                                                                    pharmcatTsv: pharmcatTsvUrl
                                                                });
                                                            }
                                                            
                                                            if (!pdfUrl && !htmlUrl) {
                                                                const jobId = data.job_id || (data.data && data.data.job_id);
                                                                console.log("Constructing URLs with job ID:", jobId);
                                                                
                                                                if (jobId) {
                                                                    pdfUrl = `/reports/${jobId}_pgx_report.pdf`;
                                                                    htmlUrl = `/reports/${jobId}_pgx_report.html`;
                                                                    console.log("Constructed URLs:", pdfUrl, htmlUrl);
                                                                }
                                                            }
                                                            
                                                            // Create results display
                                                            const resultsDiv = document.getElementById('analysisResults');
                                                            if (resultsDiv) {
                                                                resultsDiv.innerHTML = `
                                                                    <div class="alert alert-success">
                                                                        <h4>Analysis Complete!</h4>
                                                                        <p>Your pharmacogenomic analysis has been completed successfully.</p>
                                                                        
                                                                        <!-- Main Reports -->
                                                                        <div class="mt-3">
                                                                            <h5>Main Reports</h5>
                                                                            ${pdfUrl ? `<div class="mt-2">
                                                                                <a href="${pdfUrl}" class="btn btn-primary" target="_blank">
                                                                                    <i class="bi bi-file-pdf"></i> View PDF Report
                                                                                </a>
                                                                            </div>` : ''}
                                                                            ${htmlUrl ? `<div class="mt-2">
                                                                                <a href="${htmlUrl}" class="btn btn-info" target="_blank">
                                                                                    <i class="bi bi-file-code"></i> View Interactive Report
                                                                                </a>
                                                                            </div>` : ''}
                                                                        </div>
                                                                        
                                                                        <!-- PharmCAT Reports -->
                                                                        ${(pharmcatHtmlUrl || pharmcatJsonUrl || pharmcatTsvUrl) ? `
                                                                            <div class="mt-3">
                                                                                <h5>PharmCAT Reports</h5>
                                                                                ${pharmcatHtmlUrl ? `<div class="mt-2">
                                                                                    <a href="${pharmcatHtmlUrl}" class="btn btn-success" target="_blank">
                                                                                        <i class="bi bi-file-medical"></i> View PharmCAT HTML Report
                                                                                    </a>
                                                                                </div>` : ''}
                                                                                ${pharmcatJsonUrl ? `<div class="mt-2">
                                                                                    <a href="${pharmcatJsonUrl}" class="btn btn-warning" target="_blank">
                                                                                        <i class="bi bi-filetype-json"></i> View PharmCAT JSON Report
                                                                                    </a>
                                                                                </div>` : ''}
                                                                                ${pharmcatTsvUrl ? `<div class="mt-2">
                                                                                    <a href="${pharmcatTsvUrl}" class="btn btn-secondary" target="_blank">
                                                                                        <i class="bi bi-filetype-csv"></i> View PharmCAT TSV Report
                                                                                    </a>
                                                                                </div>` : ''}
                                                                            </div>
                                                                        ` : ''}
                                                                        
                                                                        <!-- Download All Reports -->
                                                                        <div class="mt-4">
                                                                            <h5>Download All Reports</h5>
                                                                            <div class="mt-2">
                                                                                <button id="downloadAllBtn" class="btn btn-dark" onclick="downloadAllReports('${data.data?.patient_id || data.patient_id || jobId}')">
                                                                                    <i class="bi bi-download"></i> Download All Reports as ZIP
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                `;
                                                                resultsDiv.classList.remove('d-none');
                                                                addLogMessage("Report links are now available", "success");
                                                            } else {
                                                                console.error("Results container not found");
                                                                addLogMessage("Error: Results container not found", "danger");
                                                            }
                                                        } else {
                                                            console.error("Processing failed:", data.message);
                                                            addLogMessage(`Error: ${data.message}`, "danger");
                                                            showError(data.message);
                                                        }
                                                        
                                                        // Re-enable the upload button
                                                        uploadButton.disabled = false;
                                                        uploadButton.textContent = 'Upload';
                                                        return;
                                                    }
                                                } catch (parseError) {
                                                    console.error("Error parsing progress data:", parseError, "Raw data:", line);
                                                    addLogMessage(`Error parsing progress update: ${parseError.message}`, 'danger');
                                                }
                                            } else {
                                                // Log any non-data lines for debugging
                                                console.log("Non-data SSE line received:", line);
                                            }
                                        } catch (lineError) {
                                            console.error("Error processing SSE line:", lineError);
                                        }
                                    }
                                }
                            } catch (readError) {
                                console.error("Error reading from stream:", readError);
                                addLogMessage(`Stream error: ${readError.message}`, 'warning');
                                
                                // Try to reconnect
                                if (reconnectAttempt < maxReconnects) {
                                    reconnectAttempt++;
                                    addLogMessage(`Attempting to reconnect (${reconnectAttempt}/${maxReconnects})...`, 'warning');
                                    await new Promise(resolve => setTimeout(resolve, 2000));
                                    attemptConnection();
                                    return;
                                } else {
                                    addLogMessage("Failed to reconnect after multiple attempts", 'danger');
                                    showError("Error in input stream. Please check reports manually.");
                                    // Re-enable the upload button
                                    uploadButton.disabled = false;
                                    uploadButton.textContent = 'Upload';
                                }
                                break;
                            }
                        }
                    } catch (error) {
                        console.error("Error monitoring progress:", error);
                        addLogMessage(`Error monitoring progress: ${error.message}`, 'danger');
                        
                        // Try to reconnect
                        if (reconnectAttempt < maxReconnects) {
                            reconnectAttempt++;
                            addLogMessage(`Attempting to reconnect (${reconnectAttempt}/${maxReconnects})...`, 'warning');
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            attemptConnection();
                            return;
                        } else {
                            showError("Error monitoring progress: " + error.message);
                            addLogMessage("Failed to reconnect after multiple attempts", 'danger');
                            uploadButton.disabled = false;
                            uploadButton.textContent = 'Upload';
                        }
                    }
                }

                attemptConnection();
            };

            // Update the file upload handler to work without auth token
            form.addEventListener('submit', async function(e) {
                // The actual upload is now handled by GenomeDownloadProgress.js
                // Prevent default just in case - for backup if the main handler fails
                e.preventDefault();
                return false;
            });

            // Function to show results
            window.showResults = function(data) {
                const resultsDiv = document.getElementById('analysisResults');
                if (!resultsDiv) {
                    console.error("Results container not found");
                    return;
                }

                console.log("Showing results with data:", data);

                // Make sure we have a data object
                if (!data) {
                    console.warn("No data provided to showResults");
                    data = {};
                }
                
                // Try to get the job ID - could be in various places
                let jobId = data.job_id;
                if (!jobId && data.data && data.data.job_id) {
                    console.log("Found job_id in nested data.data:", data.data.job_id);
                    jobId = data.data.job_id;
                }
                if (jobId) {
                    console.log("Using job_id:", jobId);
                } else {
                    console.warn("No job_id found in data");
                }
                
                // Extract URLs from all possible locations in the data object
                const reportUrls = {};
                
                // Simplified URL extraction - check both root and nested data
                const urlKeys = [
                    'pdf_report_url',
                    'html_report_url',
                    'interactive_html_report_url',
                    'pharmcat_html_report_url',
                    'pharmcat_json_report_url',
                    'pharmcat_tsv_report_url'
                ];
                
                // First, check root level data
                urlKeys.forEach(key => {
                    if (data[key]) {
                        console.log(`Found ${key} at root level:`, data[key]);
                        reportUrls[key] = data[key];
                    }
                });
                
                // Then, check nested data.data if it exists
                if (data.data) {
                    console.log("Checking nested data.data object");
                    urlKeys.forEach(key => {
                        if (data.data[key] && !reportUrls[key]) {
                            console.log(`Found ${key} in nested data:`, data.data[key]);
                            reportUrls[key] = data.data[key];
                        }
                    });
                }
                
                // SIMPLE DEBUGGING - THIS SHOULD DEFINITELY SHOW UP
                console.log("🚨🚨🚨 DEBUGGING CODE IS RUNNING! 🚨🚨🚨");
                console.log("🚨🚨🚨 PHARMCAT URLS CHECK 🚨🚨🚨");
                console.log("🚨🚨🚨 Root level pharmcat_html_report_url:", data.pharmcat_html_report_url || "NOT FOUND");
                console.log("🚨🚨🚨 Root level pharmcat_json_report_url:", data.pharmcat_json_report_url || "NOT FOUND");
                console.log("🚨🚨🚨 Root level pharmcat_tsv_report_url:", data.pharmcat_tsv_report_url || "NOT FOUND");
                
                if (data.data) {
                    console.log("🚨🚨🚨 NESTED DATA PHARMCAT URLS 🚨🚨🚨");
                    console.log("🚨🚨🚨 Nested pharmcat_html_report_url:", data.data.pharmcat_html_report_url || "NOT FOUND");
                    console.log("🚨🚨🚨 Nested pharmcat_json_report_url:", data.data.pharmcat_json_report_url || "NOT FOUND");
                    console.log("🚨🚨🚨 Nested pharmcat_tsv_report_url:", data.data.pharmcat_tsv_report_url || "NOT FOUND");
                }
                
                // Debug: Log the full data structure
                console.log("Full data received:", data);
                console.log("Data keys:", Object.keys(data));
                if (data.data) {
                    console.log("Nested data keys:", Object.keys(data.data));
                }
                
                // URLs have been extracted above
                
                // Debug: Log what was found
                console.log("After extraction, reportUrls contains:", reportUrls);
                
                // Additional debugging: Check if PharmCAT URLs exist in the data
                console.log("🔍 DETAILED PHARMCAT URL CHECK:");
                console.log("🔍 data.pharmcat_html_report_url:", data.pharmcat_html_report_url);
                console.log("🔍 data.pharmcat_json_report_url:", data.pharmcat_json_report_url);
                console.log("🔍 data.pharmcat_tsv_report_url:", data.pharmcat_tsv_report_url);
                
                if (data.data) {
                    console.log("🔍 data.data.pharmcat_html_report_url:", data.data.pharmcat_html_report_url);
                    console.log("🔍 data.data.pharmcat_json_report_url:", data.data.pharmcat_json_report_url);
                    console.log("🔍 data.pharmcat_tsv_report_url:", data.data.pharmcat_tsv_report_url);
                }
                
                // Test: Log the exact structure of the data
                console.log("🔍 FULL DATA STRUCTURE:");
                console.log(JSON.stringify(data, null, 2));
                
                // Test: Check if the issue is with the data structure
                if (data.data && typeof data.data === 'object') {
                    console.log("🔍 data.data is an object with keys:", Object.keys(data.data));
                    console.log("🔍 data.data.pharmcat_html_report_url type:", typeof data.data.pharmcat_html_report_url);
                    console.log("🔍 data.data.pharmcat_html_report_url value:", data.data.pharmcat_html_report_url);
                }
                
                // Check if the issue is with the extractUrls function
                console.log("🔍 Testing direct assignment:");
                if (data.pharmcat_html_report_url) {
                    reportUrls.pharmcat_html_report_url = data.pharmcat_html_report_url;
                    console.log("🔍 Directly assigned pharmcat_html_report_url:", reportUrls.pharmcat_html_report_url);
                }
                if (data.pharmcat_json_report_url) {
                    reportUrls.pharmcat_json_report_url = data.pharmcat_json_report_url;
                    console.log("🔍 Directly assigned pharmcat_json_report_url:", reportUrls.pharmcat_json_report_url);
                }
                if (data.pharmcat_tsv_report_url) {
                    reportUrls.pharmcat_tsv_report_url = data.pharmcat_tsv_report_url;
                    console.log("🔍 Directly assigned pharmcat_tsv_report_url:", reportUrls.pharmcat_tsv_report_url);
                }
                
                // Also check nested data
                if (data.data) {
                    if (data.data.pharmcat_html_report_url) {
                        reportUrls.pharmcat_html_report_url = data.data.pharmcat_html_report_url;
                        console.log("🔍 Directly assigned nested pharmcat_html_report_url:", reportUrls.pharmcat_html_report_url);
                    }
                    if (data.data.pharmcat_json_report_url) {
                        reportUrls.pharmcat_json_report_url = data.data.pharmcat_json_report_url;
                        console.log("🔍 Directly assigned nested pharmcat_json_report_url:", reportUrls.pharmcat_json_report_url);
                    }
                    if (data.data.pharmcat_tsv_report_url) {
                        reportUrls.pharmcat_tsv_report_url = data.data.pharmcat_tsv_report_url;
                        console.log("🔍 Directly assigned nested pharmcat_tsv_report_url:", reportUrls.pharmcat_tsv_report_url);
                    }
                }
                
                // If we have a job ID but are missing URLs, try to construct default URLs
                if (jobId) {
                    // Default URL templates for each report type
                    const defaultUrls = {
                        'pdf_report_url': `/reports/${jobId}/${jobId}_pgx_report.pdf`,
                        'html_report_url': `/reports/${jobId}/${jobId}_pgx_report.html`,
                        'interactive_html_report_url': `/reports/${jobId}/${jobId}_pgx_report_interactive.html`,
                        'pharmcat_html_report_url': `/reports/${jobId}/${jobId}_pgx_pharmcat.html`,
                        'pharmcat_json_report_url': `/reports/${jobId}/${jobId}_pgx_pharmcat.json`,
                        'pharmcat_tsv_report_url': `/reports/${jobId}/${jobId}_pgx_pharmcat.tsv`
                    };
                    
                    // Fill in any missing URLs with defaults
                    Object.keys(defaultUrls).forEach(key => {
                        if (!reportUrls[key]) {
                            reportUrls[key] = defaultUrls[key];
                        }
                    });
                }
                
                console.log("Extracted report URLs:", reportUrls);

                let resultsHtml = `
                    <div class="alert alert-success">
                        <h4>Analysis Complete!</h4>
                        <p>Your pharmacogenomic analysis has been completed successfully.</p>
                `;

                // Check if we found any report URLs
                if (Object.keys(reportUrls).length === 0) {
                    console.warn("No report URLs found in data:", data);
                    resultsHtml += `
                        <div class="mt-3 alert alert-warning">
                            <p>Report URLs not found in results data.</p>
                        </div>
                    `;
                }

                // Group the reports by type for better organization
                const reportGroups = [
                    {
                        title: "Main Reports",
                        reports: [
                            { key: 'pdf_report_url', label: 'View PDF Report', icon: 'bi-file-pdf' },
                            { key: 'html_report_url', label: 'View Interactive HTML Report', icon: 'bi-file-code' }
                        ]
                    },
                    {
                        title: "PharmCAT Reports",
                        reports: [
                            { key: 'pharmcat_html_report_url', label: 'View PharmCAT HTML Report', icon: 'bi-file-medical' },
                            { key: 'pharmcat_json_report_url', label: 'View PharmCAT JSON Report', icon: 'bi-filetype-json' },
                            { key: 'pharmcat_tsv_report_url', label: 'View PharmCAT TSV Report', icon: 'bi-filetype-csv' }
                        ]
                    }
                ];
                
                // Add report links by group
                reportGroups.forEach(group => {
                    // Check if there are any reports in this group
                    const availableReports = group.reports.filter(report => reportUrls[report.key]);
                    
                    if (availableReports.length > 0) {
                        resultsHtml += `
                            <div class="mt-3">
                                <h5>${group.title}</h5>
                        `;
                        
                        availableReports.forEach(report => {
                            resultsHtml += `
                                <div class="mt-2">
                                    <a href="${reportUrls[report.key]}" class="btn btn-primary" target="_blank">
                                        <i class="bi ${report.icon}"></i> ${report.label}
                                    </a>
                                </div>
                            `;
                        });
                        
                        resultsHtml += `</div>`;
                    }
                });

                // Add download all reports button
                const patientId = data.data?.patient_id || data.patient_id || jobId;
                if (patientId) {
                    resultsHtml += `
                        <div class="mt-4">
                            <h5>Download All Reports</h5>
                            <div class="mt-2">
                                <button id="downloadAllBtn" class="btn btn-dark" onclick="downloadAllReports('${patientId}')">
                                    <i class="bi bi-download"></i> Download All Reports as ZIP
                                </button>
                            </div>
                        </div>
                    `;
                }

                resultsHtml += `</div>`;
                resultsDiv.innerHTML = resultsHtml;
                resultsDiv.classList.remove('d-none');
                
                // Log the completion in the log panel
                addLogMessage("Analysis complete! 5 reports are available: 2 main reports (PDF, Interactive HTML) and 3 PharmCAT reports (HTML, JSON, TSV).", "success");
            }

            // Function to show error
            function showError(message) {
                const resultsDiv = document.getElementById('analysisResults');
                if (!resultsDiv) {
                    console.error("Results container not found");
                    return;
                }
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Analysis Failed</h4>
                        <p>${message}</p>
                    </div>
                `;
                resultsDiv.classList.remove('d-none');
            }

            // Function to show login form
            function showLoginForm() {
                mainContent.classList.add('d-none');
                loginForm.classList.remove('d-none');
            }
        });
        


        // Function to download and use PharmCAT example VCF for demo
        async function runPharmCatDemo() {
            try {
                // Show that we're fetching the demo file
                const logMessages = document.getElementById('logMessages');
                const progressContainer = document.getElementById('progressContainer');
                
                if (!logMessages || !progressContainer) {
                    console.error("Required elements not found");
                    return;
                }
                
                // Add to log
                window.addLogMessage("Loading PharmCAT example VCF file...", "info");

                // Show progress container
                progressContainer.classList.remove('d-none');
                
                // Update progress status
                const progressStatus = document.getElementById('progressStatus');
                if (progressStatus) {
                    progressStatus.textContent = "Preparing PharmCAT example VCF...";
                }
                
                // Disable the upload button
                const uploadButton = document.getElementById('uploadButton');
                const demoButton = document.getElementById('demoButton');
                if (uploadButton) uploadButton.disabled = true;
                if (demoButton) demoButton.disabled = true;
                
                // Instead of creating a VCF in memory, fetch the sample file
                const response = await fetch('/static/demo/pharmcat.example.vcf');
                if (!response.ok) {
                    throw new Error(`Failed to fetch example VCF: ${response.status}`);
                }

                const vcfContent = await response.text();
                
                // Create a File object from the fetched VCF content
                const demoFile = new File([vcfContent], 'pharmcat-demo.vcf', { type: 'text/plain' });
                
                // Create FormData object just like a regular file upload
                const formData = new FormData();
                formData.append('file', demoFile);
                formData.append('sample_identifier', 'PharmCAT-Demo');
                
                // Mark this as a VCF file for consistent handling
                window.isVcfFile = true;
                
                // Start progress tracking
                if (window.GenomeDownloadProgress && window.GenomeDownloadProgress.startProgressTracking) {
                    window.GenomeDownloadProgress.startProgressTracking();
                }
                
                // Make the request to the same endpoint used for regular uploads
                const uploadResponse = await fetch('/upload/genomic-data', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`Failed to upload demo file: ${uploadResponse.status}`);
                }
                
                const result = await uploadResponse.json();
                console.log("Demo upload result:", result);
                
                // Process the response just like a regular upload
                window.addLogMessage("Demo file uploaded successfully", "success");
                
                // Update file analysis display
                if (window.updateFileAnalysis) {
                    window.updateFileAnalysis(result);
                }
                
                // Start monitoring progress
                if (window.monitorProgress && result.job_id) {
                    window.monitorProgress(result.job_id);
                }
                

                
            } catch (error) {
                console.error("Error running PharmCAT demo:", error);
                window.addLogMessage(`Error running demo: ${error.message}`, "danger");
                
                // Re-enable buttons
                const uploadButton = document.getElementById('uploadButton');
                const demoButton = document.getElementById('demoButton');
                if (uploadButton) uploadButton.disabled = false;
                if (demoButton) demoButton.disabled = false;
            }
        }


        // Function to view/hide file header information
        async function viewHeader() {
            const fileInput = document.getElementById('genomicFile');
            const headerDisplay = document.getElementById('headerDisplay');
            const headerContent = document.getElementById('headerContent');
            const viewHeaderButton = document.getElementById('viewHeaderButton');

            // Check if header is currently visible and has content
            const isVisible = !headerDisplay.classList.contains('d-none');
            const hasContent = headerContent.innerHTML.trim() !== '<!-- Header content will be displayed here -->';

            // If visible and has content, hide it (toggle off)
            if (isVisible && hasContent) {
                headerDisplay.classList.add('d-none');
                viewHeaderButton.innerHTML = '<i class="bi bi-eye"></i> View Header';
                return;
            }

            // Otherwise, show header (either first time or was hidden)
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a genomic file first.');
                return;
            }

            const file = fileInput.files[0];

            // Show loading state
            viewHeaderButton.disabled = true;
            viewHeaderButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Inspecting...';
            headerContent.innerHTML = '<div class="text-center"><div class="spinner-border text-info" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Analyzing file header...</p></div>';
            headerDisplay.classList.remove('d-none');

            try {
                // Create FormData with the selected file
                const formData = new FormData();
                formData.append('file', file);

                // Make the request to the header inspection endpoint
                const response = await fetch('/upload/inspect-header', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    // Map new schema to expected format
                    const rawData = result.header_info;
                    const compat = result.compat || {};
                    const headerInfo = {
                        filename: result.original_filename || (rawData.file_info ? rawData.file_info.path.split('/').pop() : 'Unknown'),
                        file_type: rawData.file_info ? rawData.file_info.format : 'Unknown',
                        file_size: rawData.file_info ? rawData.file_info.size : undefined,
                        is_compressed: rawData.file_info ? rawData.file_info.compressed : undefined,
                        has_index: rawData.file_info ? rawData.file_info.has_index : undefined,
                        // Use workflow recommendations from backend
                        workflow: compat.workflow || {
                            recommendations: [],
                            warnings: [],
                            unsupported: false,
                            unsupported_reason: null
                        },
                        // Extract VCF info from metadata and sequences
                        vcf_info: rawData.metadata ? {
                            reference_genome: rawData.metadata.reference_genome || 'Unknown',
                            reference_genome_file: rawData.metadata.reference_genome_path || null,
                            sequencing_platform: rawData.metadata.created_by || 'Unknown',
                            sequencing_profile: (function() {
                                const seqCount = rawData.sequences ? rawData.sequences.length : 0;
                                if (seqCount > 50) return 'whole_genome_sequencing';
                                if (seqCount > 10) return 'whole_exome_sequencing';
                                if (seqCount > 0) return 'targeted_sequencing';
                                return 'unknown';
                            })(),
                            has_index: rawData.file_info ? rawData.file_info.has_index : false,
                            is_bgzipped: rawData.file_info ? rawData.file_info.compressed : false,
                            contigs: rawData.sequences ? rawData.sequences.map(seq => seq.name) : [],
                            sample_count: (function() {
                                if (Array.isArray(rawData.samples)) return rawData.samples.length;
                                if (rawData.sample) return 1;
                                return 0;
                            })(),
                            variant_count: null, // Not available in new schema
                            sample_id: (function() {
                                if (Array.isArray(rawData.samples) && rawData.samples.length > 0) {
                                    return rawData.samples[0];
                                }
                                return rawData.sample || null;
                            })(),
                            version: rawData.metadata.version || null
                        } : null
                    };

                    // Build the header display HTML with flattened vertical layout
                    let html = `
                        <!-- File Information Section -->
                        <div class="mb-4">
                            <h6 class="card-title d-flex align-items-center mb-3">
                                <i class="bi bi-file-earmark-text me-2 text-primary"></i>
                                File Information
                            </h6>
                            <div class="row g-2">
                                <div class="col-sm-4"><strong class="text-muted">Filename:</strong></div>
                                <div class="col-sm-8"><span class="badge bg-secondary">${headerInfo.filename || 'Unknown'}</span></div>

                                <div class="col-sm-4"><strong class="text-muted">File Type:</strong></div>
                                <div class="col-sm-8"><span class="badge bg-info">${headerInfo.file_type ? headerInfo.file_type.toUpperCase() : 'UNKNOWN'}</span></div>

                                <div class="col-sm-4"><strong class="text-muted">File Size:</strong></div>
                                <div class="col-sm-8">${headerInfo.file_size ? (headerInfo.file_size / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown'}</div>

                                <div class="col-sm-4"><strong class="text-muted">Compressed:</strong></div>
                                <div class="col-sm-8">
                                    <span class="badge ${headerInfo.is_compressed !== undefined ? (headerInfo.is_compressed ? 'bg-success' : 'bg-warning') : 'bg-secondary'}">
                                        ${headerInfo.is_compressed !== undefined ? (headerInfo.is_compressed ? 'Yes' : 'No') : 'Unknown'}
                                    </span>
                                </div>

                                <div class="col-sm-4"><strong class="text-muted">Has Index:</strong></div>
                                <div class="col-sm-8">
                                    <span class="badge ${headerInfo.has_index !== undefined ? (headerInfo.has_index ? 'bg-success' : 'bg-danger') : 'bg-secondary'}">
                                        ${headerInfo.has_index !== undefined ? (headerInfo.has_index ? 'Yes' : 'No') : 'Unknown'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- VCF Header Details Section (will be populated if VCF) -->
                        <div id="vcfDetailsSection" class="mb-4" style="display: none;"></div>

                        <!-- Analysis Recommendations Section -->
                        <div class="mb-3">
                            <h6 class="card-title d-flex align-items-center mb-3">
                                <i class="bi bi-gear me-2 text-primary"></i>
                                Analysis Recommendations
                            </h6>
                            <div class="mb-3">
                    `;

                    // Add workflow recommendations (with safety checks)
                    if (headerInfo.workflow && headerInfo.workflow.recommendations && headerInfo.workflow.recommendations.length > 0) {
                        html += '<div class="alert alert-info"><ul class="mb-0 mt-0">';
                        headerInfo.workflow.recommendations.forEach(rec => {
                            html += `<li>${rec}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    if (headerInfo.workflow && headerInfo.workflow.warnings && headerInfo.workflow.warnings.length > 0) {
                        html += '<div class="alert alert-warning"><strong>Warnings:</strong><ul class="mb-0 mt-2">';
                        headerInfo.workflow.warnings.forEach(warn => {
                            html += `<li>${warn}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    if (headerInfo.workflow && headerInfo.workflow.unsupported) {
                        html += `<div class="alert alert-danger"><strong>Unsupported:</strong> ${headerInfo.workflow.unsupported_reason || 'Unknown reason'}</div>`;
                    }

                    html += `
                            </div>
                        </div>
                    `;

                    // Add VCF-specific information if available (to dedicated section)
                    let vcfDetailsHtml = '';
                    if (headerInfo.vcf_info && typeof headerInfo.vcf_info === 'object') {
                        const vcf = headerInfo.vcf_info;

                        vcfDetailsHtml = `
                                        <hr class="my-3">
                                        <h6 class="d-flex align-items-center mb-3">
                                            <i class="bi bi-dna me-2 text-primary"></i>
                                            VCF Header Details
                                        </h6>
                                        <div class="row g-2">
                                            <div class="col-12">
                                                <div class="row g-2 mb-2">
                                                    <div class="col-sm-3"><strong class="text-muted small">Reference Genome:</strong></div>
                                                    <div class="col-sm-9"><span class="badge bg-primary">${vcf.reference_genome || 'Unknown'}</span></div>
                                                </div>
                                                <div class="row g-2 mb-3">
                                                    <div class="col-12"><strong class="text-muted small">Reference Genome File:</strong></div>
                                                    <div class="col-12"><small class="text-muted">${vcf.reference_genome_file || 'Not specified'}</small></div>
                                                </div>
                                                <div class="row g-2">
                                                    <div class="col-sm-3"><strong class="text-muted small">Sequencing Platform:</strong></div>
                                                    <div class="col-sm-2"><span class="badge bg-secondary">${vcf.sequencing_platform || 'Unknown'}</span></div>

                                                    <div class="col-sm-2"><strong class="text-muted small">Sample Count:</strong></div>
                                                    <div class="col-sm-2"><span class="badge bg-success">${vcf.sample_count !== undefined ? vcf.sample_count : 'Unknown'}</span></div>

                                                    <div class="col-sm-2"><strong class="text-muted small">Sequencing Profile:</strong></div>
                                                    <div class="col-sm-1"><span class="badge bg-info">${vcf.sequencing_profile ? vcf.sequencing_profile.replace('_', ' ').toUpperCase() : 'UNKNOWN'}</span></div>
                                                </div>
                                                <div class="row g-2 mt-2">
                                                    <div class="col-sm-3"><strong class="text-muted small">Variant Count:</strong></div>
                                                    <div class="col-sm-2">${vcf.variant_count !== undefined ? vcf.variant_count : 'Not counted'}</div>

                                                    <div class="col-sm-2"><strong class="text-muted small">Sample ID:</strong></div>
                                                    <div class="col-sm-5"><small class="text-muted">${vcf.sample_id || 'Not specified'}</small></div>
                                                </div>
                                                <div class="row g-2 mt-1">
                                                    <div class="col-sm-3"><strong class="text-muted small">Version:</strong></div>
                                                    <div class="col-sm-2"><span class="badge bg-info">${vcf.version || 'Unknown'}</span></div>

                                                    <div class="col-sm-2"><strong class="text-muted small">Total Contigs:</strong></div>
                                                    <div class="col-sm-5"><span class="badge bg-warning">${vcf.contigs ? vcf.contigs.length : 'Unknown'}</span></div>
                                                </div>
                                            </div>
                                        </div>
                        `;

                        if (vcf.contigs && vcf.contigs.length > 0) {
                            // Get sequence information from raw data if available
                            const sequences = rawData.sequences || [];
                            const contigDisplay = sequences.slice(0, 5).map(seq =>
                                `${seq.name} (${seq.length ? (seq.length / 1000000).toFixed(1) + 'Mb' : 'length unknown'})`
                            ).join(', ');

                            vcfDetailsHtml += `
                                        <div class="mt-3">
                                            <strong class="text-muted small">Sequence Details:</strong>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    ${contigDisplay}${sequences.length > 5 ? `<br>... and ${sequences.length - 5} more sequences` : ''}
                                                </small>
                                            </div>
                                        </div>
                            `;
                        }
                    }

                    // Close the main content
                    html += ``;

                    headerContent.innerHTML = html;

                    // Add VCF details to the dedicated section
                    const vcfSection = document.getElementById('vcfDetailsSection');
                    if (vcfSection && vcfDetailsHtml) {
                        vcfSection.innerHTML = vcfDetailsHtml;
                        vcfSection.style.display = 'block';
                    }

                } else {
                    throw new Error(result.message || 'Failed to inspect header');
                }

            } catch (error) {
                console.error('Error inspecting header:', error);
                headerContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>Error Inspecting Header</h6>
                        <p class="mb-0">${error.message}</p>
                    </div>
                `;
            } finally {
                // Reset button state
                viewHeaderButton.disabled = false;
                viewHeaderButton.innerHTML = '<i class="bi bi-eye"></i> View Header';
            }
        }

        // Function to download all reports as a zip file
        function downloadAllReports(patientId) {
            if (!patientId) {
                console.error('No patient ID provided for download');
                addLogMessage('Error: No patient ID available for download', 'danger');
                return;
            }

            console.log('Starting download for patient ID:', patientId);
            
            // Show loading state
            const downloadBtn = document.getElementById('downloadAllBtn');
            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Preparing Download...';
            }

            // Create download link
            const downloadUrl = `/upload/reports/download/${patientId}`;
            
            // Create a temporary link element and trigger download
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `pgx_reports_${patientId}.zip`;
            link.style.display = 'none';
            
            // Add to DOM, click, and remove
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Reset button state after a short delay
            setTimeout(() => {
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = '<i class="bi bi-download"></i> Download All Reports as ZIP';
                }
            }, 2000);
            
            addLogMessage('Download started for all reports', 'success');
        }

        // Stage Popup and Toggle Functionality
        window.initializeStagePopups = function() {
            console.log('Initializing stage popups...');
            
            // Handle stage indicator clicks
            const stageIndicators = document.querySelectorAll('.stage-indicator');
            stageIndicators.forEach(indicator => {
                indicator.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Close any other open popups
                    document.querySelectorAll('.stage-popup').forEach(popup => {
                        if (popup !== this.querySelector('.stage-popup')) {
                            popup.style.display = 'none';
                        }
                    });
                    
                    // Toggle current popup
                    const popup = this.querySelector('.stage-popup');
                    if (popup) {
                        const isVisible = popup.style.display === 'block';
                        popup.style.display = isVisible ? 'none' : 'block';
                    }
                });
            });
            
            // Handle toggle button clicks
            const toggleButtons = document.querySelectorAll('.toggle-button');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const stage = this.getAttribute('data-stage');
                    const indicator = document.querySelector(`[data-stage="${stage}"]`);
                    const isEnabled = indicator.getAttribute('data-enabled') === 'true';
                    
                    // Toggle the state
                    const newState = !isEnabled;
                    indicator.setAttribute('data-enabled', newState.toString());
                    
                    // Update visual state
                    if (newState) {
                        indicator.classList.remove('disabled');
                        this.classList.remove('disabled');
                        this.classList.add('enabled');
                        this.textContent = '✓ Enabled';
                    } else {
                        indicator.classList.add('disabled');
                        this.classList.remove('enabled');
                        this.classList.add('disabled');
                        this.textContent = '✗ Disabled';
                    }
                    
                    console.log(`Stage ${stage} ${newState ? 'enabled' : 'disabled'}`);
                });
            });
            
            // Close popups when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.stage-indicator')) {
                    document.querySelectorAll('.stage-popup').forEach(popup => {
                        popup.style.display = 'none';
                    });
                }
            });
        };

        // Get current stage toggle states for backend submission
        window.getStageToggleStates = function() {
            const states = {};
            const stageIndicators = document.querySelectorAll('.stage-indicator[data-toggleable="true"]');
            
            stageIndicators.forEach(indicator => {
                const stage = indicator.getAttribute('data-stage');
                const enabled = indicator.getAttribute('data-enabled') === 'true';
                states[stage] = enabled;
            });
            
            return states;
        };

        // Initialize stage popups when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing stage popups...');
            window.initializeStagePopups();
        });
    </script>
</body>
</html>