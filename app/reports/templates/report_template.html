<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pharmacogenomic Report - {{ report_id }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
        }
        .logo {
            max-width: 200px;
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .report-info {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .section {
            margin-bottom: 30px;
            position: relative;
            padding-bottom: 10px;
        }
        
        /* Ensure workflow section has proper spacing */
        .workflow-section {
            margin-bottom: 40px;
        }
        h2 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .gene-table tr:hover {
            background-color: #f5f5f5;
        }
        .drug-recommendation {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .normal {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .alert {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .gene-phenotype {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
        }
        .normal-metabolizer {
            background-color: #28a745;
        }
        .poor-metabolizer {
            background-color: #dc3545;
        }
        .intermediate-metabolizer {
            background-color: #ffc107;
            color: #333;
        }
        .rapid-metabolizer, .ultrarapid-metabolizer {
            background-color: #17a2b8;
        }
        .disclaimer {
            margin-top: 50px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            font-size: 0.9em;
            color: #666;
            position: relative;
            z-index: 0;
        }
        .footer {
            margin-top: 50px;
            text-align: center;
            font-size: 0.8em;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 20px;
            position: relative;
            z-index: 0;
        }
        .page-break {
            page-break-before: always;
        }
        
        .workflow-text {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }
        .workflow-figure {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            clear: both;
            display: block;
        }
        
        /* Ensure proper spacing around workflow content */
        .workflow-figure > * {
            margin: 0;
            padding: 0;
        }
        
        /* Ensure workflow diagram doesn't interfere with other elements */
        .workflow-figure + * {
            margin-top: 20px;
        }
        
        /* Ensure proper spacing before workflow section */
        .workflow-section {
            margin-top: 40px;
        }
        
        /* Ensure proper spacing after workflow section */
        .workflow-section + .section {
            margin-top: 30px;
        }
        .workflow-figure svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        .workflow-figure img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        /* Special styling for PDF SVG workflow */
        .workflow-svg-pdf svg {
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            position: relative;
            z-index: 1;
        }
        .workflow-svg-pdf text {
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            fill: #2c3e50 !important;
            position: relative;
            z-index: 1;
        }
        /* Enhanced PDF-specific styles for HTML workflow */
        @media print {
            .workflow-figure {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin: 20px 0 !important;
                padding: 15px !important;
                background: #f8f9fa !important;
                border: 1px solid #dee2e6 !important;
                border-radius: 8px !important;
            }
            .workflow-figure img {
                max-width: 100% !important;
                height: auto !important;
                display: block !important;
                margin: 0 auto !important;
                border-radius: 4px !important;
            }
            .workflow-figure svg {
                max-width: 100% !important;
                height: auto !important;
                background: white !important;
                border-radius: 4px !important;
            }
                    /* Ensure SVG text is visible in PDF */
        .workflow-figure svg text {
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            fill: #2c3e50 !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
        }
        .workflow-figure svg tspan {
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            fill: #2c3e50 !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
        }
            /* Ensure HTML workflow renders properly in PDF */
            .workflow-figure div {
                page-break-inside: avoid !important;
                font-family: Arial, sans-serif !important;
                font-size: 12px !important;
            }
            .workflow-figure span {
                font-family: Arial, sans-serif !important;
                display: inline-block !important;
            }
                    /* Ensure HTML workflow content is visible */
        .workflow-figure * {
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
        }
            
                    /* Style for plain text workflow */
        .workflow-text {
            font-family: 'Courier New', monospace !important;
            font-size: 12px !important;
            text-align: center !important;
            margin: 20px 0 !important;
            padding: 15px !important;
            background-color: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 5px !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            color: #2c3e50 !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
        }
        }
    </style>
</head>
<body>
    <div class="header">
        <!-- <img class="logo" src="logo.png" alt="ZaroPGx Logo"> -->
        <h1>ZaroPGx Pharmacogenomic Report</h1>
        <p>Precision Medicine through Genetic Analysis</p>
    </div>
    
    <div class="report-info">
        <p><strong>Sample ID:</strong> {{ patient_id }}</p>
        <p><strong>Report ID:</strong> {{ report_id }}</p>
        <p><strong>Report Date:</strong> {{ report_date }}</p>
    </div>

    <div class="section">
        <h2>Methodology</h2>
        <p>The sample's genetic data was analyzed using PharmCAT (Pharmacogenomics Clinical Annotation Tool), referencing CPIC (Clinical Pharmacogenetics Implementation Consortium) guidelines. Genetic variants were processed to identify star alleles and diplotypes, which were then mapped to phenotypes and relevant recommendations.</p>
    </div>

    <div class="section">
        <h2>Executive Summary</h2>
        <p>This report provides pharmacogenomic information based on the sample's genetic analysis. The information can be used to inform interpretation of genetic profiles in context.</p>
        
        <div class="summary-highlights">
            <p>This sample's genetic profile indicates:</p>
            <ul>
                {% for d in diplotypes %}
                <li>
                    <strong>{{ d.gene }}:</strong> {{ d.diplotype }} - 
                    <span class="gene-phenotype {% if 'Normal' in d.phenotype %}normal-metabolizer{% elif 'Poor' in d.phenotype %}poor-metabolizer{% elif 'Intermediate' in d.phenotype %}intermediate-metabolizer{% elif 'Rapid' in d.phenotype or 'Ultrarapid' in d.phenotype %}rapid-metabolizer{% endif %}">
                        {{ d.phenotype }}
                    </span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    
    <div class="section">
        <h2>Genetic Results</h2>
        <table class="gene-table">
            <thead>
                <tr>
                    <th>Gene</th>
                    <th>Diplotype</th>
                    <th>Phenotype</th>
                    <th>Activity Score</th>
                    <th>Implications</th>
                </tr>
            </thead>
            <tbody>
                {% for d in diplotypes %}
                <tr>
                    <td>{{ d.gene }}</td>
                    <td>{{ d.diplotype }}</td>
                    <td>{{ d.phenotype }}</td>
                    <td>{{ d.activity_score if d.activity_score else 'N/A' }}</td>
                    <td>
                        {% if 'Normal' in d.phenotype %}
                            Standard drug metabolism expected
                        {% elif 'Poor' in d.phenotype %}
                            Reduced drug metabolism may require dose adjustments
                        {% elif 'Intermediate' in d.phenotype %}
                            Slightly reduced metabolism may require monitoring
                        {% elif 'Rapid' in d.phenotype or 'Ultrarapid' in d.phenotype %}
                            Increased metabolism may reduce efficacy at standard doses
                        {% else %}
                            Consult clinical guidelines
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="section">
        <h2>Drug Recommendations</h2>
        <p>The following recommendations are based on CPIC guidelines and this sample's genetic profile:</p>
        
        {% for rec in recommendations %}
        <div class="drug-recommendation 
            {% if 'standard' in rec.recommendation.lower() or 'normal' in rec.recommendation.lower() %}normal
            {% elif 'avoid' in rec.recommendation.lower() %}alert
            {% elif 'consider' in rec.recommendation.lower() or 'alternative' in rec.recommendation.lower() %}warning
            {% else %}info{% endif %}">
            <h3>{{ rec.drug }} ({{ rec.gene }})</h3>
            <p><strong>Recommendation:</strong> {{ rec.recommendation }}</p>
            <p><strong>Strength of Evidence:</strong> {{ rec.classification }}</p>
            {% if rec.literature_references %}
            <p><strong>References:</strong> {{ rec.literature_references|join(", ") }}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    
    
    <div class="section">
        <h2>Platform and Citations</h2>
        <h3>Software Platform</h3>
        <table>
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Version</th>
                </tr>
            </thead>
            <tbody>
                {% if platform_info and platform_info|length > 0 %}
                    {% for item in platform_info %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ item.version }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="2">Not available</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>

        <h3>Citations</h3>
        <ul>
            {% if citations and citations|length > 0 %}
                {% for c in citations %}
                <li>{{ c.text }}</li>
                {% endfor %}
            {% else %}
                <li>Not available</li>
            {% endif %}
        </ul>
        <h3>PharmCAT</h3>
        <p>We acknowledge the use of PharmCAT (Pharmacogenomics Clinical Annotation Tool) for gene-level interpretations and recommendations.</p>
        <ul>
            <li>Sangkuhl K, Whirl-Carrillo M, et al. Pharmacogenomics Clinical Annotation Tool (PharmCAT). <em>Clinical Pharmacology &amp; Therapeutics</em>. 2020;107(1):203–210. See also the <a href="https://pharmcat.clinpgx.org/faqs/#create-ones-own-pdf-report-based-on-the-pharmcat-json-file" target="_blank" rel="noopener">PharmCAT FAQ</a>.</li>
        </ul>
        <h3>GATK</h3>
        <p>We acknowledge the use of the Genome Analysis Toolkit (GATK) for variant discovery.</p>
        <ul>
            <li>McKenna A, et al. The Genome Analysis Toolkit: a MapReduce framework for analyzing next-generation DNA sequencing data. <em>Genome Research</em>. 2010;20(9):1297–1303.</li>
            <li>DePristo MA, et al. A framework for variation discovery and genotyping using next-generation DNA sequencing data. <em>Nature Genetics</em>. 2011;43(5):491–498.</li>
        </ul>
        <p class="small">Additional guidance: <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035530852-How-should-I-cite-GATK-in-my-own-publications" target="_blank" rel="noopener">How to cite GATK</a>.</p>
        <h3>PyPGx</h3>
        <p>We acknowledge the use of PyPGx for star‑allele calling.</p>
        <ul>
            <li>Lee S‑B, et&nbsp;al. ClinPharmSeq: A targeted sequencing panel for clinical pharmacogenetics implementation. <em>PLOS ONE</em>. 2022.</li>
            <li>Lee S‑B, et&nbsp;al. Stargazer: a software tool for calling star alleles from next‑generation sequencing data using CYP2D6 as a model. <em>Genetics in Medicine</em>. 2018.</li>
            <li>Lee S‑B, et&nbsp;al. Calling star alleles with Stargazer in 28 pharmacogenes with whole‑genome sequences. <em>Clinical Pharmacology &amp; Therapeutics</em>. 2019.</li>
        </ul>
        <!-- Removed duplicated instructional PyPGx block -->
    </div>

    <div class="disclaimer">
        {{ disclaimer }}
    </div>

    <div class="section workflow-section" style="page-break-inside: avoid; break-inside: avoid;">
        <h2>Workflow Overview</h2>
        <div class="workflow-figure">
            {% if workflow_svg %}
              {{ workflow_svg | safe }}
            {% elif workflow_png_file_url %}
              <img src="{{ workflow_png_file_url }}" alt="Workflow Diagram" />
            {% elif workflow_png_data_uri %}
              <img src="{{ workflow_png_data_uri }}" alt="Workflow Diagram" />
            {% elif workflow_html_fallback %}
              {{ workflow_html_fallback | safe }}
            {% else %}
              <!-- Hard fail-safe directly in template -->
              <div class="workflow-text">
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>Upload</span>
                <span style='color:#5b8def;font-size:14px'>&nbsp;→&nbsp;</span>
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>Detect</span>
                <span style='color:#5b8def;font-size:14px'>&nbsp;→&nbsp;</span>
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>VCF</span>
                <span style='color:#5b8def;font-size:14px'>&nbsp;→&nbsp;</span>
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>PharmCAT</span>
                <span style='color:#5b8def;font-size:14px'>&nbsp;→&nbsp;</span>
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>Reports</span>
              </div>
            {% endif %}
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2024-2025 {{ author_name or 'Unknown Author' }}</p>
        <p>This program is licensed under the <a href="{{ license_url }}" target="_blank" rel="noopener">{{ license_name }}</a>.</p>
        <p>Source code: <a href="{{ source_url }}" target="_blank" rel="noopener">{{ source_url }}</a>.</p>
        <p>Generated on {{ report_date }}</p>
    </div>
    <!-- Debug veneer: remove in production -->
    {% if debug_json %}
    <pre style="white-space: pre-wrap; font-size: 10px; color: #666; background: #f7f7f7; border: 1px dashed #ccc; padding: 8px; margin-top: 12px;">
{{ debug_json }}
    </pre>
    {% endif %}
</body>
</html> 