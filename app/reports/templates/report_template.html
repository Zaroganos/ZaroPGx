<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pharmacogenomic Report - {{ report_id }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
        }
        .logo {
            max-width: 200px;
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .report-info {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .section {
            margin-bottom: 30px;
            position: relative;
            padding-bottom: 10px;
        }
        
        /* Ensure workflow section has proper spacing */
        .workflow-section {
            margin-bottom: 40px;
        }
        h2 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .gene-table tr:hover {
            background-color: #f5f5f5;
        }
        .drug-recommendation {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        /* Executive summary invisible columns */
        .exec-summary-table {
            width: 100%;
            border-collapse: collapse; /* tightly packed, no extra gaps */
            table-layout: auto; /* let content determine widths dynamically */
            margin-top: 10px;
        }
        .exec-summary-table td {
            padding: 4px 6px; /* compact but readable */
            border: none; /* invisible columns */
            border-bottom: 1px solid #e8e8e8; /* subtle row separator */
            vertical-align: top;
        }
        .exec-summary-table tr:last-child td {
            border-bottom: none; /* remove border from last row */
        }
        .exec-summary-number {
            text-align: left;
            white-space: nowrap;
            width: 3ch; /* minimal width for numbers like '10.' */
        }
        .exec-summary-gene {
            text-align: left;
            font-weight: bold;
            overflow-wrap: anywhere; /* allow wrapping if needed */
        }
        .exec-summary-diplotype {
            text-align: center;
            white-space: nowrap; /* diplotypes are short; keep compact */
        }
        .exec-summary-phenotype {
            text-align: left;
            white-space: nowrap;
            overflow: visible;
        }
        .exec-summary-phenotype .gene-phenotype,
        .exec-summary-phenotype .as-badge {
            vertical-align: middle;
        }
        .activity-score {
            margin-left: 8px;
            color: #555;
            font-size: 0.95em;
        }
        /* Activity Score badge (oval, like phenotype badges) */
        .as-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 4px;
            border-radius: 9999px;
            font-weight: bold;
            color: #ffffff;
            line-height: 1;
            margin-left: 4px;
            white-space: nowrap;
            width: 42px;
            flex-shrink: 0;
            overflow-wrap: normal;
            word-break: normal;
            justify-content: center;
        }
        .as-badge .as-text { font-weight: bold; }
        .as-badge .as-gauge { display: inline-block; vertical-align: middle; }
        .as-badge .as-gauge path:first-child { fill: currentColor; opacity: 0.18; }
        .as-tier-0 { background-color: #000000; color: #ffffff; } /* 0 - black with white text */
        .as-tier-1 { background-color: #dc3545; }          /* 0.25 - red */
        .as-tier-2 { background-color: #fd7e14; }          /* 0.5 - orange */
        .as-tier-3 { background-color: #ffc107; color: #333; } /* 0.75 - yellow */
        .as-tier-4 { background-color: #90EE90; }          /* 1.0-1.5 - light green */
        .as-tier-5 { background-color: #28a745; }          /* 1.75-2.25 - green */
        .as-tier-6 { 
            background-color: #20c997; 
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.1) 2px,
                rgba(255,255,255,0.1) 4px
            );
        } /* â‰¥2.5 - turquoise with racing stripes */
        .normal {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .alert {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .gene-phenotype {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            white-space: nowrap;
            max-width: max-content;
        }
        .normal-metabolizer {
            background-color: #28a745;
        }
        .poor-metabolizer {
            background-color: #dc3545;
        }
        .intermediate-metabolizer {
            background-color: #ffc107;
            color: #333;
        }
        .rapid-metabolizer, .ultrarapid-metabolizer {
            background-color: #17a2b8;
        }
        /* Possibly Wild Type: transparent background with black border */
        .likely-wild-type {
            background-color: transparent;
            color: #000;
            border: 2px solid #000;
        }
        .disclaimer {
            margin-top: 50px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            font-size: 0.9em;
            color: #666;
            position: relative;
            z-index: 0;
        }
        /* Monospaced file header styling (normal flow, full width) */
        .file-header {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre;
            background-color: transparent;
            border: none;
            padding: 0;
            border-radius: 0;
            line-height: 1.35;
            tab-size: 4;
            overflow: visible;
            word-break: normal;
        }
        .header-note {
            font-size: 0.95em;
            color: #555;
            margin: 0 0 10px 0;
        }
        /* Header section */
        .header-section {
            margin-top: 24px;
        }
        
        /* Special page layout for header section with narrower margins */
        @page header-page {
            size: A4;
            margin: 8mm; /* Narrower margins for header content */
            @bottom-right {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10px;
                color: #888;
            }
        }
        
        /* Apply special page layout to header section */
        .header-section {
            page: header-page;
        }
        
        .footer {
            margin-top: 50px;
            text-align: center;
            font-size: 0.8em;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 20px;
            position: relative;
            z-index: 0;
        }
        .page-break {
            page-break-before: always;
        }
        
        .workflow-text {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }
        .workflow-figure {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            clear: both;
            display: block;
        }
        
        /* Ensure proper spacing around workflow content */
        .workflow-figure > * {
            margin: 0;
            padding: 0;
        }
        
        /* Ensure workflow diagram doesn't interfere with other elements */
        .workflow-figure + * {
            margin-top: 20px;
        }
        
        /* Ensure proper spacing before workflow section */
        .workflow-section {
            margin-top: 40px;
        }
        
        /* Ensure proper spacing after workflow section */
        .workflow-section + .section {
            margin-top: 30px;
        }
        .workflow-figure svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        /* Force visible text in embedded SVGs */
        .workflow-figure svg text,
        .workflow-figure svg tspan {
            fill: #000000 !important;
            color: #000000 !important;
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .workflow-figure img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        /* Special styling for PDF SVG workflow */
        .workflow-svg-pdf svg {
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            position: relative;
            z-index: 1;
        }
        .workflow-svg-pdf text {
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            fill: #2c3e50 !important;
            position: relative;
            z-index: 1;
        }
        /* Enhanced PDF-specific styles for HTML workflow */
        @media print {
            /* Ensure Disclaimer ends first page */
            .disclaimer { 
                page-break-after: always !important; 
                break-after: page !important; 
            }
            /* Genomic header: new page, normal document flow */
            .header-section { page-break-before: always !important; }
            .header-section .file-header { white-space: pre !important; }
            /* Ensure Executive Summary ends with a page break so Genetic Results starts on next page */
            #exec-summary { 
                page-break-after: always !important; 
                break-after: page !important; 
            }
            /* Full-page workflow */
            .workflow-section {
                page-break-before: always !important;
                page-break-after: always !important;
                margin: 0 !important;
                padding: 0 !important;
                position: relative !important; /* enable absolute positioning for title */
            }
            .workflow-figure {
                margin: 0 !important;
                padding: 0 !important;
                background: #ffffff !important;
                border: none !important;
                border-radius: 0 !important;
                width: 178mm !important;
                height: 265mm !important;
            }
            /* Overlay the title on top-left of the workflow page */
            .workflow-section > h2 {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                z-index: 2 !important;
                background: transparent !important;
            }
            .workflow-figure img {
                width: 178mm !important;
                height: 265mm !important;
                display: block !important;
                margin: 0 auto !important;
                border-radius: 0 !important;
            }
            .workflow-figure svg {
                width: 178mm !important;
                height: 265mm !important;
                background: white !important;
                border-radius: 0 !important;
            }
            .workflow-figure svg text,
            .workflow-figure svg tspan {
                fill: #000000 !important;
                color: #000000 !important;
                font-family: Arial, sans-serif !important;
                font-size: 12px !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
                    /* Ensure SVG text is visible in PDF */
        .workflow-figure svg text {
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            fill: #2c3e50 !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
            /* For PDFs ensure header preserves exact spacing; WeasyPrint prints with this */
            .file-header {
                white-space: pre;
            }
        }
        .workflow-figure svg tspan {
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            fill: #2c3e50 !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
        }
            /* Ensure HTML workflow renders properly in PDF */
            .workflow-figure div {
                page-break-inside: avoid !important;
                font-family: Arial, sans-serif !important;
                font-size: 12px !important;
            }
            .workflow-figure span {
                font-family: Arial, sans-serif !important;
                display: inline-block !important;
            }
                    /* Ensure HTML workflow content is visible */
        .workflow-figure * {
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
        }
            
                    /* Style for plain text workflow */
        .workflow-text {
            font-family: 'Courier New', monospace !important;
            font-size: 12px !important;
            text-align: center !important;
            margin: 20px 0 !important;
            padding: 15px !important;
            background-color: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 5px !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            color: #2c3e50 !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
        }
        }
    </style>
</head>
<body>
    <div class="header">
        <!-- <img class="logo" src="logo.png" alt="ZaroPGx Logo"> -->
        <h1>Individual Pharmacogenomic Report</h1>
        <p>Powered by ZaroPGx, a Zaromics Software Tool</p>
    </div>
    
    <div class="report-info">
        <p><strong>Sample ID:</strong> {{ sample_identifier or patient_id }}</p>
        <p><strong>Report ID:</strong> {{ report_id }}</p>
        <p><strong>Report Date:</strong> {{ report_date }}</p>
    </div>

    <div class="section">
        <h2>Methodology</h2>
        <p>The sample's genetic data were analyzed with the ZaroPGx pipeline, composed of several analytic tools, culminating in recommendation matching by PharmCAT (the Pharmacogenomics Clinical Annotation Tool), which references evidence-level A clinical guidelines published by CPIC (Clinical Pharmacogenetics Implementation Consortium), DPWG (Dutch Pharmacogenetics Working Group), and FDA (U.S. Food and Drug Administration). Notable pharmacogenetic variants were identified to determine star alleles and diplotypes, which were mapped to phenotypes and ultimately matched with relevant recommendations.</p>
    </div>

    <!-- Disclaimer moved here (below Methodology) for both HTML and PDF -->
    <div class="disclaimer">
        {{ disclaimer }}
    </div>

    <div id="exec-summary" class="section">
        <h2>Executive Summary</h2>
        <p>This report provides pharmacogenomic information derived from in silico analysis of the sample's genetic data. The information can be used to inform interpretation of gene-drug interactions in context.</p>
        
        <div class="summary-highlights">
            <p>This sample's genetic profile indicates:</p>
            <table class="exec-summary-table">
                <tbody>
                    {# Prefer TSV-driven Executive Summary rows when provided #}
                    {% if execsum_from_tsv %}
                        {% for r in execsum_from_tsv|sort(attribute='gene') %}
                        <tr>
                            <td class="exec-summary-number">{{ loop.index }}.</td>
                            <td class="exec-summary-gene">{{ r.gene }}</td>
                            <td class="exec-summary-diplotype">{{ r.rec_lookup_diplotype or '' }}</td>
                            <td class="exec-summary-phenotype">
                                {% set ph = r.rec_lookup_phenotype or '' %}
                                {% set asv = r.rec_lookup_activity_score %}
                                <span class="gene-phenotype {% if 'Possibly Wild Type' in ph %}likely-wild-type{% elif 'Normal' in ph %}normal-metabolizer{% elif 'Poor' in ph %}poor-metabolizer{% elif 'Intermediate' in ph %}intermediate-metabolizer{% elif 'Rapid' in ph or 'Ultrarapid' in ph %}rapid-metabolizer{% endif %}">{{ ph }}</span>
                                {% if asv is not none %}
                                    {% set s = asv if asv >= 0 else 0 %}
                                    {% if s == 0 %}
                                        {% set tier = 0 %}
                                    {% elif s <= 0.25 %}
                                        {% set tier = 1 %}
                                    {% elif s <= 0.5 %}
                                        {% set tier = 2 %}
                                    {% elif s <= 0.75 %}
                                        {% set tier = 3 %}
                                    {% elif s <= 1.5 %}
                                        {% set tier = 4 %}
                                    {% elif s <= 2.25 %}
                                        {% set tier = 5 %}
                                    {% else %}
                                        {% set tier = 6 %}
                                    {% endif %}
                                    <span class="as-badge as-tier-{{ tier }}" title="Activity Score">
                                        <svg class="as-gauge" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                                            <path d="M12 20a8 8 0 1 1 8-8h-2a6 6 0 1 0-6 6v2z"></path>
                                            <path d="M12 12l5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"></path>
                                        </svg>
                                        <span class="as-text">{{ s }}</span>
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for d in diplotypes|sort(attribute='gene') %}
                        <tr>
                            <td class="exec-summary-number">{{ loop.index }}.</td>
                            <td class="exec-summary-gene">{{ d.gene }}</td>
                            <td class="exec-summary-diplotype">{{ d.diplotype }}</td>
                            <td class="exec-summary-phenotype">
                                <span class="gene-phenotype {% if 'Possibly Wild Type' in d.phenotype %}likely-wild-type{% elif 'Normal' in d.phenotype %}normal-metabolizer{% elif 'Poor' in d.phenotype %}poor-metabolizer{% elif 'Intermediate' in d.phenotype %}intermediate-metabolizer{% elif 'Rapid' in d.phenotype or 'Ultrarapid' in d.phenotype %}rapid-metabolizer{% endif %}">{{ d.phenotype }}</span>
                                {% if d.activity_score is not none %}
                                    {% set s = d.activity_score if d.activity_score >= 0 else 0 %}
                                    {% if s == 0 %}
                                        {% set tier = 0 %}
                                    {% elif s <= 0.25 %}
                                        {% set tier = 1 %}
                                    {% elif s <= 0.5 %}
                                        {% set tier = 2 %}
                                    {% elif s <= 0.75 %}
                                        {% set tier = 3 %}
                                    {% elif s <= 1.5 %}
                                        {% set tier = 4 %}
                                    {% elif s <= 2.25 %}
                                        {% set tier = 5 %}
                                    {% else %}
                                        {% set tier = 6 %}
                                    {% endif %}
                                    <span class="as-badge as-tier-{{ tier }}" title="Activity Score">
                                        <svg class="as-gauge" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                                            <path d="M12 20a8 8 0 1 1 8-8h-2a6 6 0 1 0-6 6v2z"></path>
                                            <path d="M12 12l5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"></path>
                                        </svg>
                                        <span class="as-text">{{ s }}</span>
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="section">
        <h2>Genetic Results</h2>
        <table class="gene-table">
            <thead>
                <tr>
                    <th>Gene</th>
                    <th>Diplotype</th>
                    <th>Phenotype</th>
                    <th>Activity Score</th>
                    <th>Implications</th>
                    <th>T*</th>
                </tr>
            </thead>
            <tbody>
                {% for d in diplotypes|sort(attribute='gene') %}
                <tr>
                    <td>{{ d.gene }}</td>
                    <td>{{ d.diplotype }}</td>
                    <td>{{ d.phenotype }}</td>
                    <td>{{ d.activity_score if d.activity_score else '' }}</td>
                    <td>
                        {% if 'Normal' in d.phenotype %}
                            Standard drug metabolism expected
                        {% elif 'Poor' in d.phenotype %}
                            Reduced drug metabolism may require dose adjustments
                        {% elif 'Intermediate' in d.phenotype %}
                            Slightly reduced metabolism may require monitoring
                        {% elif 'Rapid' in d.phenotype or 'Ultrarapid' in d.phenotype %}
                            Increased metabolism may reduce efficacy at standard doses
                        {% else %}
                            Consult clinical guidelines
                        {% endif %}
                    </td>
                    <td class="tool-source">{{ d.tool_source if d.tool_source else 'P' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="tool-key">
            <h4>Tool Key:</h4>
            <p><strong>C</strong> = PharmCAT | 
               <strong>P</strong> = PyPGx | 
               <strong>O</strong> = OptiType | 
               <strong>M</strong> = MitoZ</p>
        </div>
    </div>
    
    <div class="section">
        <h2>Drug Recommendations</h2>
        <p>The following recommendations are based on CPIC, DPWG, and FDA guidelines concerning the sample's genetic profile:</p>
        
        {% for rec in recommendations %}
        <div class="drug-recommendation 
            {% if 'standard' in rec.recommendation.lower() or 'normal' in rec.recommendation.lower() %}normal
            {% elif 'avoid' in rec.recommendation.lower() %}alert
            {% elif 'consider' in rec.recommendation.lower() or 'alternative' in rec.recommendation.lower() %}warning
            {% else %}info{% endif %}">
            <h3>{{ rec.drug }} ({{ rec.gene }})</h3>
            <p><strong>Recommendation:</strong> {{ rec.recommendation }}</p>
            <p><strong>Strength of Evidence:</strong> {{ rec.classification }}</p>
            {% if rec.literature_references %}
            <p><strong>References:</strong> {{ rec.literature_references|join(", ") }}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    
    
    <div class="section">
        <h2>Platform and Citations</h2>
        <h3>Software Platform</h3>
        <table>
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Version</th>
                </tr>
            </thead>
            <tbody>
                {% if platform_info and platform_info|length > 0 %}
                    {% for item in platform_info %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ item.version }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="2">Not available</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>

        <!-- Genomic Header placed after Software Platform, on a new PDF page -->
        {% if header_text %}
        <div class="header-section">
            <h3>Genomic Datafile Header</h3>
            <p class="header-note">The sample genomic datafile's header is reproduced below. Please note that the information below is derived from the original submission, before any preprocessing (conversion, re-alignment, etc.) took place.</p>
            <pre class="file-header">{{ header_text|e }}</pre>
        </div>
        <!-- Page break to return to normal margins after header section -->
        <div class="page-break"></div>
        {% endif %}

        <h3>Citations</h3>
        <ul>
            {% if citations and citations|length > 0 %}
                {% for c in citations %}
                <li>{{ c.text }}</li>
                {% endfor %}
            {% else %}
                <li>Not available</li>
            {% endif %}
        </ul>
        <h3>PharmCAT</h3>
        <p>We thank PharmCAT (Pharmacogenomics Clinical Annotation Tool) for gene-level interpretations and recommendations.</p>
        <ul>
            <li>Sangkuhl K, Whirl-Carrillo M, et al. Pharmacogenomics Clinical Annotation Tool (PharmCAT). <em>Clinical Pharmacology &amp; Therapeutics</em>. 2020;107(1):203â€“210. See also the <a href="https://pharmcat.clinpgx.org/faqs/#create-ones-own-pdf-report-based-on-the-pharmcat-json-file" target="_blank" rel="noopener">PharmCAT FAQ</a>.</li>
        </ul>
        <h3>GATK</h3>
        <p>We thank Genome Analysis Toolkit (GATK) for providing various tools and functions.</p>
        <ul>
            <li>McKenna A, et al. The Genome Analysis Toolkit: a MapReduce framework for analyzing next-generation DNA sequencing data. <em>Genome Research</em>. 2010;20(9):1297â€“1303.</li>
            <li>DePristo MA, et al. A framework for variation discovery and genotyping using next-generation DNA sequencing data. <em>Nature Genetics</em>. 2011;43(5):491â€“498.</li>
        </ul>
        <p class="small">Additional guidance: <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035530852-How-should-I-cite-GATK-in-my-own-publications" target="_blank" rel="noopener">How to cite GATK</a>.</p>
        <h3>PyPGx</h3>
        <p>We thank PyPGx for starâ€‘allele calling, and additional functions.</p>
        <ul>
            <li>Lee Sâ€‘B, et&nbsp;al. ClinPharmSeq: A targeted sequencing panel for clinical pharmacogenetics implementation. <em>PLOS ONE</em>. 2022.</li>
            <li>Lee Sâ€‘B, et&nbsp;al. Stargazer: a software tool for calling star alleles from nextâ€‘generation sequencing data using CYP2D6 as a model. <em>Genetics in Medicine</em>. 2018.</li>
            <li>Lee Sâ€‘B, et&nbsp;al. Calling star alleles with Stargazer in 28 pharmacogenes with wholeâ€‘genome sequences. <em>Clinical Pharmacology &amp; Therapeutics</em>. 2019.</li>
        </ul>
        <!-- Removed duplicated instructional PyPGx block -->
    </div>

    

    <div class="section workflow-section" style="page-break-inside: avoid; break-inside: avoid;">
        <h2>Workflow Diagram</h2>
        
        <!-- Primary Workflow Diagram (Mermaid preferred, Graphviz fallback) -->
        <div class="workflow-figure">
            {% if workflow_kroki_svg %}
              <!-- Prefer Mermaid diagram -->
              {{ workflow_kroki_svg | safe }}
            {% elif workflow_svg %}
              <!-- Fallback to Graphviz SVG -->
              {{ workflow_svg | safe }}
            {% elif workflow_png_file_url %}
              <!-- Fallback to PNG file -->
              <img src="{{ workflow_png_file_url }}" alt="Workflow Diagram" />
            {% elif workflow_png_data_uri %}
              <!-- Fallback to PNG data URI -->
              <img src="{{ workflow_png_data_uri }}" alt="Workflow Diagram" />
            {% elif workflow_html_fallback %}
              <!-- Fallback to HTML -->
              {{ workflow_html_fallback | safe }}
            {% else %}
              <!-- Hard fail-safe directly in template -->
              <div class="workflow-text">
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>Upload</span>
                <span style='color:#5b8def;font-size:14px'>&nbsp;â†’&nbsp;</span>
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>Detect</span>
                <span style='color:#5b8def;font-size:14px'>&nbsp;â†’&nbsp;</span>
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>VCF</span>
                <span style='color:#5b8def;font-size:14px'>&nbsp;â†’&nbsp;</span>
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>PharmCAT</span>
                <span style='color:#5b8def;font-size:14px'>&nbsp;â†’&nbsp;</span>
                <span style='display:inline-block;padding:8px 12px;border:1px solid #b5bdc9;border-radius:6px;background:#f5f7fa;margin:2px 4px;font-size:12px'>Reports</span>
              </div>
            {% endif %}
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2024-{{ current_year }} {{ author_name or 'Unknown Author' }}</p>
        <p>This program is licensed under the <a href="{{ license_url }}" target="_blank" rel="noopener">{{ license_name }}</a>.</p>
        <p>Source code: <a href="{{ source_url }}" target="_blank" rel="noopener">{{ source_url }}</a>.</p>
        <p>Generated on {{ report_date }}</p>
    </div>
    <!-- Debug veneer: remove in production -->
    {% if debug_json %}
    <pre style="white-space: pre-wrap; font-size: 10px; color: #666; background: #f7f7f7; border: 1px dashed #ccc; padding: 8px; margin-top: 12px;">
{{ debug_json }}
    </pre>
    {% endif %}
</body>
</html> 